# 施設予約システム 機能一覧

## 目次
- [一般利用者向け機能](#一般利用者向け機能)
- [職員向け機能](#職員向け機能)
  - [基本管理機能](#基本管理機能)
  - [予約代行機能](#予約代行機能)
  - [会員管理機能](#会員管理機能)
  - [貸し館システム管理機能](#貸し館システム管理機能)
- [システム仕様](#システム仕様)
- [API エンドポイント一覧](#api-エンドポイント一覧)

---

## 一般利用者向け機能

### 1. 会員登録・認証
- **会員登録**: メールアドレス、パスワード、氏名、電話番号、組織名（任意）、住所（任意）
- **メール認証**: 登録時に認証メール送信、認証完了後にログイン可能
- **ログイン**: JWT トークンによる認証
- **パスワード管理**: パスワードリセット機能（メールによるトークン送信）

### 2. マイページ
- **プロフィール表示**: 登録情報の確認
- **プロフィール編集**: 氏名、電話番号、組織名、住所の変更
- **パスワード変更**: 現在のパスワードを確認して新パスワードに変更
- **退会処理**: アカウントの論理削除（将来の再登録に対応）

### 3. 予約機能
- **施設閲覧**: 利用可能な施設・部屋の一覧表示
- **空き状況確認**: 指定日の空き状況をカレンダー形式で確認
- **予約申請**: 部屋、日付、時間帯、人数、付帯設備を選択して予約
- **予約一覧**: 自分の予約履歴を確認（今後の予約、過去の予約）
- **予約詳細**: 予約内容の詳細確認
- **予約キャンセル**: 予約のキャンセル処理

### 4. 利用料金
- **料金計算**: 基本料金 + 付帯設備料金 + 空調料金 + 物販料金の自動計算
- **料金表示**: 予約時に料金の見積もり表示

---

## 職員向け機能

### 基本管理機能

#### 1. ダッシュボード
- **統計情報**: 予約件数、利用者数、収益などの統計表示
- **最新予約**: 直近の予約情報表示
- **アラート**: 承認待ち予約、未処理事項の通知

#### 2. 予約管理
- **予約一覧**: 全予約の検索・フィルタリング（日付、状態、ユーザー、部屋）
- **予約詳細**: 予約内容の詳細確認
- **予約承認**: 予約申請の承認・却下
- **予約キャンセル**: 職員側からの予約キャンセル
- **ステータス管理**: pending（承認待ち）→ approved（承認済み）→ completed（完了）

#### 3. 利用管理
- **チェックイン**: 利用開始時の記録
- **チェックアウト**: 利用終了時の記録
- **利用履歴**: 過去の利用記録の確認

#### 4. ユーザー管理
- **ユーザー一覧**: 登録ユーザーの検索・閲覧
- **ユーザー詳細**: ユーザー情報の確認
- **予約履歴**: ユーザーごとの予約履歴表示

#### 5. 施設管理
- **施設一覧**: 登録施設の一覧表示
- **施設追加**: 新規施設の登録
- **施設編集**: 施設情報の変更（名前、説明、収容人数）
- **施設削除**: 施設の論理削除
- **部屋管理**: 施設内の部屋の管理

#### 6. 部屋管理
- **部屋一覧**: 登録部屋の一覧表示
- **部屋追加**: 新規部屋の登録
- **部屋編集**: 部屋情報の変更
- **部屋削除**: 部屋の論理削除
- **料金設定**: 時間帯ごとの基本料金・空調料金設定
- **利用可能設備**: 部屋で利用可能な付帯設備の登録

#### 7. 付帯設備管理
- **設備一覧**: 登録設備の一覧表示
- **設備追加**: 新規設備の登録（名前、説明、料金）
- **設備編集**: 設備情報の変更
- **設備削除**: 設備の論理削除
- **利用可能部屋**: 設備が利用可能な部屋の登録

#### 8. 職員管理（管理者のみ）
- **職員一覧**: 登録職員の一覧表示
- **職員追加**: 新規職員の登録（email、パスワード、氏名、役割）
- **職員編集**: 職員情報の変更
- **職員削除**: 職員の論理削除
- **役割管理**: staff（一般職員）/ admin（管理者）の権限設定

---

### 予約代行機能

#### 9. 会員向け予約代行
- **会員検索**: 既存会員の検索
- **予約作成**: 会員に代わって予約を作成
- **代行記録**: どの職員が誰のために予約したかを記録
- **予約キャンセル**: 会員に代わって予約をキャンセル

#### 10. ゲスト向け予約代行
- **ゲスト予約**: 非会員（ゲスト）の予約を代行作成
- **ゲスト情報**: 予約時にゲスト情報（氏名、電話番号など）を記録
- **代行記録**: どの職員が予約したかを記録

#### 11. 代行予約管理
- **代行予約一覧**: 職員が作成した予約の一覧
- **統計情報**: 職員ごとの代行予約件数、会員/ゲスト別の統計

---

### 会員管理機能

#### 12. 会員新規登録（職員による）
- **会員登録**: 職員が会員情報を入力して新規会員を登録
- **自動認証**: 職員登録の会員は自動的にメール認証済みとなる
- **初期パスワード**: 職員が初期パスワードを設定（会員に通知して変更を促す）

#### 13. 会員情報管理
- **会員検索**: 氏名、メールアドレス、電話番号で検索
- **会員詳細**: 会員情報の詳細表示
- **情報編集**: 会員情報の変更（氏名、電話番号、組織名、住所）
- **メール認証**: 未認証会員の手動認証

#### 14. 会員退会処理
- **退会確認**: 未完了の予約がないか確認
- **退会処理**: 会員の論理削除
- **メール変更**: 退会時にメールアドレスを変更して将来の再登録を可能にする

---

### 貸し館システム管理機能

#### 15. 時間帯管理
- **時間帯一覧**: 登録されている時間帯の一覧（午前、午後、夜間など）
- **時間帯追加**: 新規時間帯の登録（名前、コード、開始時刻、終了時刻、所要時間）
- **時間帯編集**: 時間帯情報の変更
- **時間帯削除**: 時間帯の削除（論理削除または物理削除）
- **表示順設定**: 時間帯の表示順序の設定
- **時間帯タイプ**: regular（通常）、extension（延長）、flexible（自由）

#### 16. 部屋別時間帯料金設定
- **料金設定**: 部屋ごと、時間帯ごとの料金設定
- **基本料金**: 時間帯の基本利用料金
- **空調料金**: 1時間あたりの空調料金
- **利用可否**: 特定の時間帯を利用不可に設定
- **料金一覧**: 部屋の全時間帯料金の一覧表示

#### 17. イレギュラー施設対応（柔軟な時間設定）
- **柔軟時間設定**: 時間帯固定ではなく自由な時間設定が可能（例：シャワー室）
- **最小利用時間**: 最低利用時間の設定（例：30分）
- **時間単位**: 料金計算の時間単位（例：30分単位）
- **単位料金**: 時間単位あたりの料金（例：30分で100円）

#### 18. 物販管理
- **商品一覧**: 販売商品の一覧（駐車券、その他物販）
- **商品登録**: 新規商品の登録（商品名、カテゴリ、価格、在庫数）
- **商品編集**: 商品情報の変更
- **商品削除**: 商品の論理削除
- **在庫管理**: 在庫数の確認と調整（在庫無制限の商品も対応）
- **販売可否**: 商品の販売可否設定

#### 19. 売上管理
- **売上記録**: 商品販売時の記録（予約と紐付けまたは単独販売）
- **自動在庫調整**: 販売時に自動的に在庫を減算
- **売上一覧**: 日付、商品、職員でフィルタリング可能
- **売上統計**: 期間指定での売上集計（商品別、カテゴリ別、職員別）
- **予約連携**: 予約に関連する物販の合計金額を自動計算

#### 20. 部屋-設備関連管理（双方向）
- **部屋側管理**: 部屋管理画面から利用可能設備を一括設定
  - 複数設備の選択と一括登録
  - 設備ごとの利用可否設定
- **設備側管理**: 設備管理画面から利用可能部屋を一括設定
  - 複数部屋の選択と一括登録
  - 部屋ごとの利用可否設定
- **関連一覧**:
  - 部屋に設定されている設備一覧
  - 設備が利用可能な部屋一覧

#### 21. 休館日・部分休業管理
- **全館休業日**: 施設全体の休館日設定（既存の closed_dates テーブル）
- **部屋別休業日**: 特定の部屋のみ利用不可にする日の設定
- **時間帯別休業**: 特定の時間帯のみ利用不可に設定
- **休業タイプ**:
  - full（全館休業）
  - partial（一部休業）
  - year_end（年末年始）
- **休業日一覧**: 部屋別、日付範囲でフィルタリング可能
- **休業日削除**: 設定済み休業日の削除
- **予約確認**: 既存予約がある場合は休業日設定を制限
- **利用可否確認**: 指定日・部屋・時間帯の利用可否を確認

---

## システム仕様

### 認証・権限
- **JWT認証**: トークンベースの認証システム
- **役割ベース**: user（一般利用者）、staff（職員）、admin（管理者）
- **アクセス制御**: エンドポイントごとの権限チェック

### データ管理
- **論理削除**: ユーザー、施設、部屋、設備、職員は論理削除（データは保持）
- **活動ログ**: 重要な操作は activity_logs に記録
- **トランザクション**: データ整合性を保つためのトランザクション処理

### 料金計算
- **基本料金**: 部屋の時間帯別基本料金
- **空調料金**: 利用時間に基づく空調料金
- **設備料金**: 選択した付帯設備の料金
- **物販料金**: 購入した商品の料金
- **合計金額**: 上記すべてを合算した total_amount

### メール機能
- **会員登録時**: メール認証用トークン送信
- **パスワードリセット**: リセット用トークン送信
- **予約通知**: 予約作成・承認・キャンセル時の通知（実装可能）

---

## API エンドポイント一覧

### 一般利用者向けエンドポイント

#### 認証
```
POST   /api/auth/register              会員登録
GET    /api/auth/verify-email/:token   メール認証
POST   /api/auth/login                 ログイン
POST   /api/auth/forgot-password       パスワードリセット要求
POST   /api/auth/reset-password        パスワードリセット実行
```

#### マイページ
```
GET    /api/users/me                   プロフィール取得
PATCH  /api/users/me                   プロフィール更新
POST   /api/users/me/change-password   パスワード変更
DELETE /api/users/me                   退会
```

#### 予約
```
GET    /api/facilities                 施設一覧取得
GET    /api/facilities/:id             施設詳細取得
GET    /api/rooms                      部屋一覧取得
GET    /api/rooms/:id                  部屋詳細取得
GET    /api/rooms/availability         空き状況確認
POST   /api/applications               予約申請
GET    /api/applications               自分の予約一覧
GET    /api/applications/:id           予約詳細
DELETE /api/applications/:id           予約キャンセル
```

---

### 職員向けエンドポイント

#### 予約管理
```
GET    /api/staff/applications         全予約一覧
GET    /api/staff/applications/:id     予約詳細
POST   /api/staff/applications/:id/approve   予約承認
POST   /api/staff/applications/:id/reject    予約却下
DELETE /api/staff/applications/:id     予約削除
```

#### 利用管理
```
POST   /api/staff/usage/check-in       チェックイン
POST   /api/staff/usage/check-out      チェックアウト
GET    /api/staff/usage                利用履歴取得
```

#### ユーザー管理
```
GET    /api/staff/users                ユーザー一覧
GET    /api/staff/users/:id            ユーザー詳細
GET    /api/staff/users/:id/applications   ユーザーの予約履歴
```

#### 施設管理
```
GET    /api/staff/facilities           施設一覧
POST   /api/staff/facilities           施設追加
GET    /api/staff/facilities/:id       施設詳細
PATCH  /api/staff/facilities/:id       施設更新
DELETE /api/staff/facilities/:id       施設削除
```

#### 部屋管理
```
GET    /api/staff/rooms                部屋一覧
POST   /api/staff/rooms                部屋追加
GET    /api/staff/rooms/:id            部屋詳細
PATCH  /api/staff/rooms/:id            部屋更新
DELETE /api/staff/rooms/:id            部屋削除
```

#### 付帯設備管理
```
GET    /api/staff/equipment            設備一覧
POST   /api/staff/equipment            設備追加
GET    /api/staff/equipment/:id        設備詳細
PATCH  /api/staff/equipment/:id        設備更新
DELETE /api/staff/equipment/:id        設備削除
```

#### 職員管理（管理者のみ）
```
GET    /api/staff/staff                職員一覧
POST   /api/staff/staff                職員追加
GET    /api/staff/staff/:id            職員詳細
PATCH  /api/staff/staff/:id            職員更新
DELETE /api/staff/staff/:id            職員削除
```

#### 予約代行
```
POST   /api/staff/proxy-reservations/member    会員向け予約代行
POST   /api/staff/proxy-reservations/guest     ゲスト向け予約代行
GET    /api/staff/proxy-reservations           代行予約一覧
GET    /api/staff/proxy-reservations/stats     代行予約統計
```

#### 会員管理
```
POST   /api/staff/members/register             職員による会員登録
DELETE /api/staff/members/:userId/withdraw     職員による会員退会処理
```

#### 時間帯管理
```
GET    /api/staff/timeslots                    時間帯一覧
POST   /api/staff/timeslots                    時間帯追加
PATCH  /api/staff/timeslots/:id                時間帯更新
DELETE /api/staff/timeslots/:id                時間帯削除
POST   /api/staff/rooms/:roomId/timeslots/:timeSlotId/prices   部屋別時間帯料金設定
GET    /api/staff/rooms/:roomId/timeslots/prices               部屋の時間帯料金一覧
```

#### 物販管理
```
GET    /api/staff/products                     商品一覧
POST   /api/staff/products                     商品追加
PATCH  /api/staff/products/:id                 商品更新
DELETE /api/staff/products/:id                 商品削除
POST   /api/staff/sales                        売上記録
GET    /api/staff/sales                        売上一覧
GET    /api/staff/sales/stats                  売上統計
```

#### 部屋-設備関連管理
```
GET    /api/staff/rooms/:roomId/equipment              部屋の設備一覧
GET    /api/staff/equipment/:equipmentId/rooms         設備の利用可能部屋一覧
PUT    /api/staff/rooms/:roomId/equipment              部屋の設備一括設定
PUT    /api/staff/equipment/:equipmentId/rooms         設備の利用可能部屋一括設定
```

#### 休館日管理
```
POST   /api/staff/room-closed-dates            部屋別休業日追加
GET    /api/staff/room-closed-dates            部屋別休業日一覧
DELETE /api/staff/room-closed-dates/:id        部屋別休業日削除
```

---

## データベーステーブル

### 主要テーブル
- `users`: 一般利用者
- `staff`: 職員
- `facilities`: 施設
- `rooms`: 部屋
- `equipment`: 付帯設備
- `applications`: 予約申請
- `usage_records`: 利用記録
- `closed_dates`: 全館休業日
- `activity_logs`: 活動ログ

### 拡張テーブル
- `time_slots`: 時間帯定義
- `room_time_slot_prices`: 部屋別時間帯料金
- `room_equipment`: 部屋-設備関連
- `products`: 商品マスタ
- `sales`: 売上記録
- `room_closed_dates`: 部屋別休業日
- `application_proxies`: 予約代行記録

---

## 備考

### イレギュラー施設の例
**シャワー室**:
- `rooms.is_flexible_time = true`
- `rooms.min_duration_minutes = 30`
- `rooms.time_unit_minutes = 30`
- `rooms.price_per_unit = 100`
→ 30分単位で自由に予約可能、30分ごとに100円

### 物販の例
**駐車券**:
- `products` テーブルに登録
- `name = '駐車券'`
- `category = 'parking'`
- `price = 100`
- `stock_quantity = NULL`（在庫無制限）
- 予約時または単独で販売可能

### 休業日の種類
1. **全館休業** (`closed_dates` テーブル)
   - 施設全体が休業

2. **部屋別休業** (`room_closed_dates` テーブル)
   - 特定の部屋のみ休業
   - 全日または特定時間帯のみ

3. **年末年始** (`closed_dates.closure_type = 'year_end'`)
   - 年末年始の休業期間

---

**バージョン**: 1.0
**最終更新**: 2025年11月17日
