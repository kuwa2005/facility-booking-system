<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f5f5f5;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    header {
      background-color: #2563eb;
      color: white;
      padding: 1rem 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header .container {
      max-width: 1200px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { font-size: 1.5rem; font-weight: 600; }
    header nav {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }
    header nav a {
      color: white;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    header nav a:hover { background-color: rgba(255, 255, 255, 0.1); }
    main { padding: 3rem 0; min-height: calc(100vh - 200px); }
    .page-header {
      margin-bottom: 2rem;
    }
    .page-header h2 {
      font-size: 2rem;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }
    .page-header p {
      color: #6b7280;
    }
    .grid {
      display: grid;
      gap: 2rem;
      grid-template-columns: 1fr 1fr;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    .card h3 {
      font-size: 1.25rem;
      margin-bottom: 1.5rem;
      color: #1f2937;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #e5e7eb;
    }
    .profile-image {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .profile-image img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #2563eb;
    }
    .profile-placeholder {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background-color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      font-size: 3rem;
    }
    dl {
      margin: 1rem 0;
    }
    dt {
      font-weight: 600;
      margin-top: 1rem;
      color: #6b7280;
      font-size: 0.875rem;
    }
    dd {
      margin-left: 0;
      padding: 0.5rem 0;
      border-bottom: 1px solid #e5e7eb;
      color: #1f2937;
    }
    .btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
      transition: all 0.3s;
    }
    .btn-primary {
      background-color: #2563eb;
      color: white;
    }
    .btn-primary:hover {
      background-color: #1d4ed8;
    }
    .btn-outline {
      background-color: white;
      color: #2563eb;
      border: 1px solid #2563eb;
    }
    .btn-outline:hover {
      background-color: #eff6ff;
    }
    .btn-danger {
      background-color: #ef4444;
      color: white;
    }
    .btn-danger:hover {
      background-color: #dc2626;
    }
    .btn-block {
      display: block;
      width: 100%;
    }
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .reservation-item {
      padding: 1rem;
      background-color: #f9fafb;
      border-radius: 8px;
      border-left: 4px solid #2563eb;
      margin-bottom: 1rem;
    }
    .reservation-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
    }
    .reservation-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #1f2937;
    }
    .reservation-date {
      color: #6b7280;
      font-size: 0.875rem;
    }
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #9ca3af;
    }
    footer {
      background-color: #1e40af;
      color: white;
      padding: 2rem 0;
      margin-top: 4rem;
      text-align: center;
    }
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>
        <a href="/" style="color: white; text-decoration: none;">æ–½è¨­äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </a>
      </h1>
      <nav>
        <a href="/rooms">æ–½è¨­ä¸€è¦§</a>
        <a href="/availability">ç©ºãçŠ¶æ³ç¢ºèª</a>
        <a href="/contact">ãŠå•åˆã›</a>
        <a href="/my-page">ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
        <a href="/my-reservations">äºˆç´„ä¸€è¦§</a>
        <a href="/logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="page-header">
        <h2>ãƒã‚¤ãƒšãƒ¼ã‚¸</h2>
        <p>ã‚ˆã†ã“ãã€<%= profile.name %> ã•ã‚“</p>
      </div>

      <div class="grid">
        <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
        <div>
          <div class="card">
            <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>

            <div class="profile-image">
              <% if (profile.profile_image_path) { %>
                <img src="/<%= profile.profile_image_path %>" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ">
              <% } else { %>
                <div class="profile-placeholder">ğŸ‘¤</div>
              <% } %>
            </div>

            <dl>
              <dt>æ°å</dt>
              <dd><%= profile.name %></dd>

              <% if (profile.nickname) { %>
                <dt>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </dt>
                <dd><%= profile.nickname %></dd>
              <% } %>

              <dt>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</dt>
              <dd><%= profile.email %></dd>

              <dt>é›»è©±ç•ªå·</dt>
              <dd><%= profile.phone %></dd>

              <% if (profile.organization_name) { %>
                <dt>çµ„ç¹”ãƒ»å›£ä½“å</dt>
                <dd><%= profile.organization_name %></dd>
              <% } %>
            </dl>

            <div style="margin-top: 1.5rem;">
              <a href="/my-page/edit" class="btn btn-primary btn-block">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</a>
            </div>
          </div>
        </div>

        <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div>
          <div class="card">
            <h3>äºˆç´„ç®¡ç†</h3>
            <div class="action-buttons">
              <a href="/my-reservations" class="btn btn-outline">äºˆç´„ä¸€è¦§ã‚’è¦‹ã‚‹</a>
              <a href="/availability" class="btn btn-primary">æ–°è¦äºˆç´„</a>
            </div>
          </div>

          <div class="card">
            <h3>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</h3>
            <div class="action-buttons">
              <a href="/my-page/change-password" class="btn btn-outline">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</a>
            </div>
          </div>

          <div class="card">
            <h3>â­ ãƒã‚¤ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
            <div id="myReviews" style="min-height: 100px;">
              <p style="color: #9ca3af; text-align: center; padding: 2rem;">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
          </div>

          <div class="card">
            <h3>â¤ï¸ ãŠæ°—ã«å…¥ã‚Šæ–½è¨­</h3>
            <p style="color: #6b7280; margin-bottom: 1rem; font-size: 0.875rem;">
              ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã—ãŸæ–½è¨­ã‚’ç®¡ç†ã§ãã¾ã™
            </p>
            <a href="/my-page/favorites" class="btn btn-outline btn-block">
              ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ã‚’è¦‹ã‚‹
            </a>
          </div>

          <div class="card">
            <h3>ğŸ“¢ ãŠçŸ¥ã‚‰ã›</h3>
            <p style="color: #6b7280; margin-bottom: 1rem; font-size: 0.875rem;">
              æ–½è¨­ã‹ã‚‰ã®é‡è¦ãªãŠçŸ¥ã‚‰ã›ã‚’ç¢ºèªã§ãã¾ã™
            </p>
            <a href="/my-page/announcements" class="btn btn-outline btn-block">
              ãŠçŸ¥ã‚‰ã›ã‚’è¦‹ã‚‹
            </a>
          </div>

          <div class="card">
            <h3>âœ‰ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
            <p style="color: #6b7280; margin-bottom: 1rem; font-size: 0.875rem;">
              æ–½è¨­ç®¡ç†è€…ã¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚„ã‚Šå–ã‚ŠãŒã§ãã¾ã™
            </p>
            <div id="unreadBadge" style="display: none; background-color: #ef4444; color: white; padding: 0.5rem; border-radius: 6px; margin-bottom: 1rem; text-align: center; font-weight: 600;">
              æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã™
            </div>
            <a href="/my-page/messages" class="btn btn-outline btn-block">
              ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ã‚‹
            </a>
          </div>
        </div>
      </div>

      <!-- ç›´è¿‘ã®äºˆç´„ -->
      <% if (upcomingReservations && upcomingReservations.length > 0) { %>
        <div class="card">
          <h3>ç›´è¿‘ã®äºˆç´„</h3>
          <% upcomingReservations.slice(0, 3).forEach(function(reservation) { %>
            <div class="reservation-item">
              <div class="reservation-header">
                <div>
                  <div class="reservation-title"><%= reservation.event_name %></div>
                  <div class="reservation-date">
                    <% if (reservation.first_date) { %>
                      <%= new Date(reservation.first_date).toLocaleDateString('ja-JP') %>
                      <% if (reservation.first_date !== reservation.last_date) { %>
                        ï½ <%= new Date(reservation.last_date).toLocaleDateString('ja-JP') %>
                      <% } %>
                    <% } %>
                  </div>
                </div>
                <a href="/my-reservations/<%= reservation.id %>" class="btn btn-outline" style="padding: 0.5rem 1rem;">è©³ç´°</a>
              </div>
            </div>
          <% }); %>
          <div style="margin-top: 1rem; text-align: center;">
            <a href="/my-reservations" style="color: #2563eb; text-decoration: none; font-weight: 500;">ã™ã¹ã¦ã®äºˆç´„ã‚’è¦‹ã‚‹ â†’</a>
          </div>
        </div>
      <% } else { %>
        <div class="card">
          <h3>äºˆç´„</h3>
          <div class="empty-state">
            <p style="font-size: 1.125rem; margin-bottom: 0.5rem;">äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</p>
            <p style="font-size: 0.875rem;">æ–½è¨­ã‚’äºˆç´„ã—ã¦ã¿ã¾ã—ã‚‡ã†</p>
            <a href="/availability" class="btn btn-primary" style="margin-top: 1rem; display: inline-block;">æ–½è¨­ã‚’äºˆç´„ã™ã‚‹</a>
          </div>
        </div>
      <% } %>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 æ–½è¨­äºˆç´„ã‚·ã‚¹ãƒ†ãƒ . All rights reserved.</p>
    </div>
  </footer>

  <script>
    // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—ãƒ»è¡¨ç¤º
    async function loadMyReviews() {
      try {
        const response = await fetch('/api/user/reviews');
        const data = await response.json();

        const reviewsEl = document.getElementById('myReviews');

        if (data.reviews && data.reviews.length > 0) {
          reviewsEl.innerHTML = '';

          // æœ€æ–°3ä»¶ã®ã¿è¡¨ç¤º
          data.reviews.slice(0, 3).forEach(review => {
            const reviewDiv = document.createElement('div');
            reviewDiv.className = 'reservation-item';
            reviewDiv.style.marginBottom = '1rem';

            const stars = generateStars(review.rating);
            const createdDate = new Date(review.created_at).toLocaleDateString('ja-JP');

            reviewDiv.innerHTML = `
              <div class="reservation-header">
                <div>
                  <div class="reservation-title" style="color: #fbbf24; font-size: 1rem; margin-bottom: 0.25rem;">${stars}</div>
                  <div class="reservation-title" style="font-size: 1rem;">${escapeHtml(review.title)}</div>
                  <div class="reservation-date">${createdDate}</div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                  <button onclick="editReview(${review.id})" class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.875rem;">ç·¨é›†</button>
                  <button onclick="deleteReview(${review.id})" class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.875rem; background-color: #ef4444; color: white;">å‰Šé™¤</button>
                </div>
              </div>
            `;

            reviewsEl.appendChild(reviewDiv);
          });

          if (data.reviews.length > 3) {
            const moreDiv = document.createElement('div');
            moreDiv.style.marginTop = '1rem';
            moreDiv.style.textAlign = 'center';
            moreDiv.innerHTML = `
              <p style="color: #6b7280; font-size: 0.875rem;">ä»– ${data.reviews.length - 3} ä»¶ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼</p>
            `;
            reviewsEl.appendChild(moreDiv);
          }
        } else {
          reviewsEl.innerHTML = `
            <p style="color: #9ca3af; text-align: center; padding: 2rem; font-size: 0.875rem;">
              ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã—ã¦ã„ã¾ã›ã‚“
            </p>
          `;
        }
      } catch (error) {
        console.error('Failed to load reviews:', error);
        document.getElementById('myReviews').innerHTML = `
          <p style="color: #ef4444; text-align: center; padding: 2rem; font-size: 0.875rem;">
            ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ
          </p>
        `;
      }
    }

    function generateStars(rating) {
      let stars = '';
      for (let i = 0; i < 5; i++) {
        stars += i < rating ? 'â˜…' : 'â˜†';
      }
      return stars;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function editReview(reviewId) {
      window.location.href = `/my-page/reviews/${reviewId}/edit`;
    }

    async function deleteReview(reviewId) {
      if (!confirm('ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      try {
        const response = await fetch(`/api/user/reviews/${reviewId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
          loadMyReviews(); // å†èª­ã¿è¾¼ã¿
        } else {
          const data = await response.json();
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (error) {
        console.error('Failed to delete review:', error);
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã‚’å–å¾—ãƒ»è¡¨ç¤º
    async function loadUnreadCount() {
      try {
        const response = await fetch('/api/user/messages/unread/count');
        const result = await response.json();

        if (result.success && result.data && result.data.count > 0) {
          const badge = document.getElementById('unreadBadge');
          badge.textContent = `æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒ${result.data.count}ä»¶ã‚ã‚Šã¾ã™`;
          badge.style.display = 'block';
        }
      } catch (error) {
        console.error('Failed to load unread count:', error);
      }
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã‚’å–å¾—
    loadMyReviews();
    loadUnreadCount();
  </script>
</body>
</html>
