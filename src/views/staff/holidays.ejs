<div class="page-header">
  <h1 class="page-title">ç¥æ—¥ç®¡ç†</h1>
  <p class="page-description">ç¥æ—¥ã®ç™»éŒ²ã¨ç®¡ç†ï¼ˆæ–½è¨­åˆ©ç”¨æ–™é‡‘ï¼ˆåœŸæ—¥ç¥ï¼‰ã®åˆ¤å®šã®ã¿ã«ä½¿ã‚ã‚Œã¾ã™ï¼‰</p>
</div>

<!-- å¹´åº¦é¸æŠã¨æ–°è¦ç™»éŒ² -->
<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <div style="display: flex; align-items: center; gap: 1rem;">
      <label style="font-weight: 500;">è¡¨ç¤ºå¹´åº¦:</label>
      <select id="yearSelect" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" onchange="loadHolidays()">
        <!-- JavaScript ã§å‹•çš„ã«ç”Ÿæˆ -->
      </select>
      <button onclick="loadHolidays()" class="btn btn-primary" style="padding: 0.5rem 1rem;">æ›´æ–°</button>
    </div>
    <div style="display: flex; gap: 0.5rem;">
      <button onclick="bulkRegisterHolidays()" class="btn btn-info" style="background: #17a2b8;">ğŸ“… 1å¹´åˆ†ä¸€æ‹¬ç™»éŒ²</button>
      <button onclick="showCreateModal()" class="btn btn-success">+ æ–°è¦ç¥æ—¥ç™»éŒ²</button>
    </div>
  </div>
</div>

<!-- ç¥æ—¥ä¸€è¦§ -->
<div class="card">
  <h2 class="card-title">ç¥æ—¥ä¸€è¦§</h2>
  <div id="holidayContainer">
    <p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>
</div>

<!-- æ–°è¦ç™»éŒ²/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="holidayModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
  <div style="background-color: white; max-width: 600px; margin: 2rem auto; border-radius: 8px; padding: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 id="modalTitle" style="margin: 0;">ç¥æ—¥ç™»éŒ²</h2>
      <button onclick="closeHolidayModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
    </div>
    <form id="holidayForm" style="display: grid; gap: 1rem;">
      <input type="hidden" id="holidayId">

      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æ—¥ä»˜ *</label>
        <input type="date" id="holidayDate" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
      </div>

      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ç¥æ—¥å *</label>
        <input type="text" id="holidayName" required maxlength="255" placeholder="ä¾‹: å…ƒæ—¥ã€æˆäººã®æ—¥" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
      </div>

      <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #ecf0f1;">
        <button type="button" onclick="closeHolidayModal()" class="btn" style="background-color: #95a5a6; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="submit" class="btn btn-success" id="submitButton">ç™»éŒ²</button>
      </div>
    </form>
  </div>
</div>

<script>

let currentYear = new Date().getFullYear();
let allHolidays = [];

// åˆæœŸãƒ­ãƒ¼ãƒ‰
document.addEventListener('DOMContentLoaded', () => {
  initYearSelect();
  loadHolidays();
});

// å¹´åº¦é¸æŠã‚’åˆæœŸåŒ–
function initYearSelect() {
  const yearSelect = document.getElementById('yearSelect');
  const currentYear = new Date().getFullYear();

  for (let year = currentYear - 5; year <= currentYear + 5; year++) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = `${year}å¹´`;
    if (year === currentYear) {
      option.selected = true;
    }
    yearSelect.appendChild(option);
  }
}

// ç¥æ—¥ã‚’èª­ã¿è¾¼ã¿
async function loadHolidays() {
  const year = document.getElementById('yearSelect').value;

  try {
    const res = await fetch(`/api/staff/holidays?year=${year}`, {
      credentials: 'include'
    });

    if (!res.ok) {
      throw new Error('Failed to load holidays');
    }

    const data = await res.json();
    allHolidays = data.holidays || [];
    displayHolidays();
  } catch (error) {
    console.error('Error loading holidays:', error);
    document.getElementById('holidayContainer').innerHTML = '<p style="text-align: center; color: #e74c3c;">ç¥æ—¥ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
  }
}

// ç¥æ—¥ã‚’è¡¨ç¤º
function displayHolidays() {
  if (allHolidays.length === 0) {
    document.getElementById('holidayContainer').innerHTML = '<p style="text-align: center; color: #7f8c8d;">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ç¥æ—¥ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    return;
  }

  const html = `
    <div style="overflow-x: auto;">
      <table class="table">
        <thead>
          <tr>
            <th>æ—¥ä»˜</th>
            <th>ç¥æ—¥å</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          ${allHolidays.map(holiday => `
            <tr>
              <td>${new Date(holiday.date).toLocaleDateString('ja-JP')}</td>
              <td><strong>${holiday.name}</strong></td>
              <td>
                <button onclick="showEditModal(${holiday.id})" class="btn btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem; margin-right: 0.5rem;">ç·¨é›†</button>
                <button onclick="deleteHoliday(${holiday.id})" class="btn btn-danger" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">å‰Šé™¤</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  document.getElementById('holidayContainer').innerHTML = html;
}

// æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
function showCreateModal() {
  document.getElementById('modalTitle').textContent = 'ç¥æ—¥ç™»éŒ²';
  document.getElementById('submitButton').textContent = 'ç™»éŒ²';
  document.getElementById('holidayForm').reset();
  document.getElementById('holidayId').value = '';
  document.getElementById('holidayModal').style.display = 'block';
}

// ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
function showEditModal(id) {
  const holiday = allHolidays.find(h => h.id === id);
  if (!holiday) return;

  document.getElementById('modalTitle').textContent = 'ç¥æ—¥ç·¨é›†';
  document.getElementById('submitButton').textContent = 'æ›´æ–°';
  document.getElementById('holidayId').value = holiday.id;
  document.getElementById('holidayDate').value = holiday.date;
  document.getElementById('holidayName').value = holiday.name;
  document.getElementById('holidayModal').style.display = 'block';
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeHolidayModal() {
  document.getElementById('holidayModal').style.display = 'none';
}

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
document.getElementById('holidayForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const id = document.getElementById('holidayId').value;
  const data = {
    date: document.getElementById('holidayDate').value,
    name: document.getElementById('holidayName').value.trim(),
  };

  try {
    const url = id ? `/api/staff/holidays/${id}` : '/api/staff/holidays';
    const method = id ? 'PATCH' : 'POST';

    const res = await fetch(url, {
      method,
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    });

    if (!res.ok) {
      const error = await res.json();
      await showError(error.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      return;
    }

    await showSuccess(id ? 'ç¥æ—¥ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'ç¥æ—¥ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
    closeHolidayModal();
    await loadHolidays();
  } catch (error) {
    console.error('Error saving holiday:', error);
    await showError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
});

// ç¥æ—¥ã‚’å‰Šé™¤
async function deleteHoliday(id) {
  const holiday = allHolidays.find(h => h.id === id);
  if (!holiday) return;

  const confirmed = await confirm(`ã€Œ${holiday.name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`);
  if (!confirmed) return;

  try {
    const res = await fetch(`/api/staff/holidays/${id}`, {
      method: 'DELETE',
      credentials: 'include'
    });

    if (!res.ok) {
      const error = await res.json();
      await showError(error.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      return;
    }

    await showSuccess('ç¥æ—¥ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    await loadHolidays();
  } catch (error) {
    console.error('Error deleting holiday:', error);
    await showError('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('holidayModal').addEventListener('click', (e) => {
  if (e.target.id === 'holidayModal') {
    closeHolidayModal();
  }
});

// 1å¹´åˆ†ã®ç¥æ—¥ã‚’ä¸€æ‹¬ç™»éŒ²
async function bulkRegisterHolidays() {
  const year = parseInt(document.getElementById('yearSelect').value);

  const confirmed = await confirm(`${year}å¹´ã®æ—¥æœ¬ã®ç¥æ—¥ã‚’ä¸€æ‹¬ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\n\nä»¥ä¸‹ã®ç¥æ—¥ãŒç™»éŒ²ã•ã‚Œã¾ã™ï¼š\n- å…ƒæ—¥ã€å»ºå›½è¨˜å¿µã®æ—¥ã€å¤©çš‡èª•ç”Ÿæ—¥\n- æ˜¥åˆ†ã®æ—¥ã€æ˜­å’Œã®æ—¥\n- æ†²æ³•è¨˜å¿µæ—¥ã€ã¿ã©ã‚Šã®æ—¥ã€ã“ã©ã‚‚ã®æ—¥\n- æµ·ã®æ—¥ã€å±±ã®æ—¥\n- æ•¬è€ã®æ—¥ã€ç§‹åˆ†ã®æ—¥\n- ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥ã€æ–‡åŒ–ã®æ—¥ã€å‹¤åŠ´æ„Ÿè¬ã®æ—¥\n- æˆäººã®æ—¥ï¼ˆãƒãƒƒãƒ”ãƒ¼ãƒãƒ³ãƒ‡ãƒ¼ï¼‰\n\nâ€»æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®ç¥æ—¥ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™`);
  if (!confirmed) return;

  try {
    const res = await fetch('/api/staff/holidays/bulk-register', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ year }),
      credentials: 'include'
    });

    const data = await res.json();

    if (!res.ok) {
      await showError(data.error || 'ä¸€æ‹¬ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
      return;
    }

    let message = `${data.created}ä»¶ã®ç¥æ—¥ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`;
    if (data.skipped > 0) {
      message += `\nï¼ˆ${data.skipped}ä»¶ã¯æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸï¼‰`;
    }
    if (data.errors && data.errors.length > 0) {
      message += `\n\nã‚¨ãƒ©ãƒ¼:\n${data.errors.join('\n')}`;
    }

    await showSuccess(message);
    await loadHolidays();
  } catch (error) {
    console.error('Error bulk registering holidays:', error);
    await showError('ä¸€æ‹¬ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}
</script>
