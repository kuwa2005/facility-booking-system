<div class="page-header">
  <h1 class="page-title">システム設定</h1>
  <p class="page-description">システム全体の設定と構成管理</p>
</div>

<!-- 設定カテゴリ -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
  <!-- 基本設定 -->
  <div class="card">
    <h3 style="margin-bottom: 1rem; color: #2c3e50;">基本設定</h3>
    <form id="basicSettingsForm" style="display: grid; gap: 1rem;">
      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">サイト名</label>
        <input type="text" id="siteName" value="施設予約システム" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">管理者メールアドレス</label>
        <input type="email" id="adminEmail" value="admin@example.com" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">お問い合わせ電話番号</label>
        <input type="tel" id="contactPhone" value="03-1234-5678" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div>
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" id="maintenanceMode">
          <span>メンテナンスモード（利用者のアクセスを制限）</span>
        </label>
      </div>
      <button type="submit" class="btn btn-primary">基本設定を保存</button>
    </form>
  </div>

  <!-- 予約設定 -->
  <div class="card">
    <h3 style="margin-bottom: 1rem; color: #2c3e50;">予約設定</h3>
    <form id="reservationSettingsForm" style="display: grid; gap: 1rem;">
      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">最大予約可能日数（日後まで）</label>
        <input type="number" id="maxReservationDays" value="90" min="1" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">予約申請の締切（日前まで）</label>
        <input type="number" id="reservationDeadlineDays" value="7" min="0" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">キャンセル料金発生日数（日前から）</label>
        <input type="number" id="cancellationFeeDays" value="14" min="0" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">キャンセル料率（%）</label>
        <input type="number" id="cancellationFeeRate" value="50" min="0" max="100" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div>
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" id="requireApproval" checked>
          <span>予約に職員の承認を必要とする</span>
        </label>
      </div>
      <button type="submit" class="btn btn-primary">予約設定を保存</button>
    </form>
  </div>

  <!-- メール設定 -->
  <div class="card">
    <h3 style="margin-bottom: 1rem; color: #2c3e50;">メール設定</h3>
    <form id="emailSettingsForm" style="display: grid; gap: 1rem;">
      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">SMTPサーバー</label>
        <input type="text" id="smtpHost" value="smtp.example.com" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">SMTPポート</label>
        <input type="number" id="smtpPort" value="587" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">送信者名</label>
        <input type="text" id="emailFromName" value="施設予約システム" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">送信者アドレス</label>
        <input type="email" id="emailFromAddress" value="noreply@example.com" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div>
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" id="emailEnabled" checked>
          <span>メール通知を有効にする</span>
        </label>
      </div>
      <div style="display: flex; gap: 1rem;">
        <button type="submit" class="btn btn-primary" style="flex: 1;">メール設定を保存</button>
        <button type="button" onclick="sendTestEmail()" class="btn" style="flex: 1; background-color: #27ae60; color: white;">📧 テストメール送信</button>
      </div>
    </form>
  </div>
</div>

<!-- 営業時間設定 -->
<div class="card">
  <h3 style="margin-bottom: 1.5rem; color: #2c3e50;">営業時間設定</h3>
  <div style="overflow-x: auto;">
    <table class="table">
      <thead>
        <tr>
          <th>曜日</th>
          <th>営業</th>
          <th>開始時刻</th>
          <th>終了時刻</th>
        </tr>
      </thead>
      <tbody id="businessHoursTable">
        <!-- JavaScriptで動的に生成 -->
      </tbody>
    </table>
  </div>
  <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
    <button onclick="saveBusinessHours()" class="btn btn-primary">営業時間を保存</button>
  </div>
</div>

<!-- データ管理 -->
<div class="card">
  <h3 style="margin-bottom: 1.5rem; color: #2c3e50;">データ管理</h3>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
    <div style="padding: 1.5rem; background-color: #f8f9fa; border-radius: 8px;">
      <h4 style="margin-bottom: 0.5rem;">データベースバックアップ</h4>
      <p style="font-size: 0.875rem; color: #7f8c8d; margin-bottom: 1rem;">システムデータの完全バックアップを作成</p>
      <button onclick="createBackup()" class="btn btn-primary" style="width: 100%;">バックアップ作成</button>
    </div>
    <div style="padding: 1.5rem; background-color: #f8f9fa; border-radius: 8px;">
      <h4 style="margin-bottom: 0.5rem;">古いデータのクリーンアップ</h4>
      <p style="font-size: 0.875rem; color: #7f8c8d; margin-bottom: 1rem;">1年以上前のキャンセル済み予約を削除</p>
      <button onclick="cleanupOldData()" class="btn" style="width: 100%; background-color: #e67e22; color: white;">クリーンアップ実行</button>
    </div>
    <div style="padding: 1.5rem; background-color: #f8f9fa; border-radius: 8px;">
      <h4 style="margin-bottom: 0.5rem;">システムログのエクスポート</h4>
      <p style="font-size: 0.875rem; color: #7f8c8d; margin-bottom: 1rem;">システムログをCSV形式でダウンロード</p>
      <button onclick="exportLogs()" class="btn" style="width: 100%; background-color: #27ae60; color: white;">ログをエクスポート</button>
    </div>
  </div>
</div>

<!-- 危険な操作 -->
<div class="card" style="border: 2px solid #e74c3c;">
  <h3 style="margin-bottom: 1.5rem; color: #e74c3c;">危険な操作</h3>
  <div style="padding: 1rem; background-color: #fee; border-radius: 4px; margin-bottom: 1rem;">
    <p style="color: #c0392b; font-weight: 600;">以下の操作は取り消せません。実行する前に必ずバックアップを作成してください。</p>
  </div>
  <div style="display: grid; gap: 1rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
      <div>
        <h4 style="margin-bottom: 0.25rem;">すべての予約データをリセット</h4>
        <p style="font-size: 0.875rem; color: #7f8c8d; margin: 0;">すべての予約と利用記録を削除します</p>
      </div>
      <button onclick="resetReservations()" class="btn btn-danger">リセット</button>
    </div>
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
      <div>
        <h4 style="margin-bottom: 0.25rem;">すべてのユーザーデータをリセット</h4>
        <p style="font-size: 0.875rem; color: #7f8c8d; margin: 0;">職員を除くすべてのユーザーアカウントを削除します</p>
      </div>
      <button onclick="resetUsers()" class="btn btn-danger">リセット</button>
    </div>
  </div>
</div>

<script>
const token = document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];

// 初期ロード
document.addEventListener('DOMContentLoaded', () => {
  loadSettings();
  loadBusinessHours();

  // フォーム送信イベント
  document.getElementById('basicSettingsForm').addEventListener('submit', (e) => {
    e.preventDefault();
    saveBasicSettings();
  });

  document.getElementById('reservationSettingsForm').addEventListener('submit', (e) => {
    e.preventDefault();
    saveReservationSettings();
  });

  document.getElementById('emailSettingsForm').addEventListener('submit', (e) => {
    e.preventDefault();
    saveEmailSettings();
  });
});

// 設定を読み込み
async function loadSettings() {
  try {
    const res = await fetch('/api/staff/settings', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const settings = await res.json();

    // 基本設定
    if (settings.site_name) {
      document.getElementById('siteName').value = settings.site_name.value;
    }
    if (settings.admin_email) {
      document.getElementById('adminEmail').value = settings.admin_email.value;
    }
    if (settings.contact_phone) {
      document.getElementById('contactPhone').value = settings.contact_phone.value;
    }
    if (settings.maintenance_mode) {
      document.getElementById('maintenanceMode').checked = settings.maintenance_mode.value;
    }

    // 予約設定
    if (settings.reservation_advance_days) {
      document.getElementById('maxReservationDays').value = settings.reservation_advance_days.value;
    }
    if (settings.reservation_deadline_days) {
      document.getElementById('reservationDeadlineDays').value = settings.reservation_deadline_days.value;
    }
    if (settings.cancellation_fee_days) {
      document.getElementById('cancellationFeeDays').value = settings.cancellation_fee_days.value;
    }
    if (settings.cancellation_fee_rate) {
      document.getElementById('cancellationFeeRate').value = settings.cancellation_fee_rate.value;
    }
    if (settings.require_approval) {
      document.getElementById('requireApproval').checked = settings.require_approval.value;
    }

    // メール設定
    if (settings.smtp_host) {
      document.getElementById('smtpHost').value = settings.smtp_host.value;
    }
    if (settings.smtp_port) {
      document.getElementById('smtpPort').value = settings.smtp_port.value;
    }
    if (settings.email_from_name) {
      document.getElementById('emailFromName').value = settings.email_from_name.value;
    }
    if (settings.email_from_address) {
      document.getElementById('emailFromAddress').value = settings.email_from_address.value;
    }
    if (settings.email_enabled) {
      document.getElementById('emailEnabled').checked = settings.email_enabled.value;
    }
  } catch (error) {
    console.error('Error loading settings:', error);
  }
}

// 営業時間テーブルを読み込み
async function loadBusinessHours() {
  const days = ['月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日', '日曜日'];
  const defaultHours = {
    open: true,
    startTime: '09:00',
    endTime: '21:00'
  };

  let businessHoursData = [];

  try {
    // データベースから営業時間を取得
    const res = await fetch('/api/staff/settings', {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (res.ok) {
      const settings = await res.json();
      if (settings.business_hours && settings.business_hours.value) {
        businessHoursData = settings.business_hours.value;
      }
    }
  } catch (error) {
    console.error('Error loading business hours:', error);
  }

  const html = days.map((day, index) => {
    // データベースから読み込んだ値があればそれを使用、なければデフォルト値
    const dayData = businessHoursData.find(d => d.day === day) || defaultHours;

    return `
      <tr>
        <td><strong>${day}</strong></td>
        <td>
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="dayOpen_${index}" ${dayData.open ? 'checked' : ''}>
            <span>営業</span>
          </label>
        </td>
        <td>
          <input type="time" id="dayStart_${index}" value="${dayData.startTime || defaultHours.startTime}" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </td>
        <td>
          <input type="time" id="dayEnd_${index}" value="${dayData.endTime || defaultHours.endTime}" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </td>
      </tr>
    `;
  }).join('');

  document.getElementById('businessHoursTable').innerHTML = html;
}

// 基本設定を保存
async function saveBasicSettings() {
  const settings = {
    siteName: document.getElementById('siteName').value,
    adminEmail: document.getElementById('adminEmail').value,
    contactPhone: document.getElementById('contactPhone').value,
    maintenanceMode: document.getElementById('maintenanceMode').checked
  };

  try {
    const res = await fetch('/api/staff/settings/basic', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(settings)
    });

    if (res.ok) {
      alert('基本設定を保存しました');
    } else {
      const error = await res.json();
      alert('保存に失敗しました: ' + (error.error || '不明なエラー'));
    }
  } catch (error) {
    console.error('Error saving basic settings:', error);
    alert('保存に失敗しました');
  }
}

// 予約設定を保存
async function saveReservationSettings() {
  const settings = {
    maxReservationDays: parseInt(document.getElementById('maxReservationDays').value),
    reservationDeadlineDays: parseInt(document.getElementById('reservationDeadlineDays').value),
    cancellationFeeDays: parseInt(document.getElementById('cancellationFeeDays').value),
    cancellationFeeRate: parseInt(document.getElementById('cancellationFeeRate').value),
    requireApproval: document.getElementById('requireApproval').checked
  };

  try {
    const res = await fetch('/api/staff/settings/reservation', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(settings)
    });

    if (res.ok) {
      alert('予約設定を保存しました');
    } else {
      const error = await res.json();
      alert('保存に失敗しました: ' + (error.error || '不明なエラー'));
    }
  } catch (error) {
    console.error('Error saving reservation settings:', error);
    alert('保存に失敗しました');
  }
}

// メール設定を保存
async function saveEmailSettings() {
  const settings = {
    smtpHost: document.getElementById('smtpHost').value,
    smtpPort: parseInt(document.getElementById('smtpPort').value),
    emailFromName: document.getElementById('emailFromName').value,
    emailFromAddress: document.getElementById('emailFromAddress').value,
    emailEnabled: document.getElementById('emailEnabled').checked
  };

  try {
    const res = await fetch('/api/staff/settings/email', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(settings)
    });

    if (res.ok) {
      alert('メール設定を保存しました');
    } else {
      const error = await res.json();
      alert('保存に失敗しました: ' + (error.error || '不明なエラー'));
    }
  } catch (error) {
    console.error('Error saving email settings:', error);
    alert('保存に失敗しました');
  }
}

// テストメールを送信
function sendTestEmail() {
  const smtpHost = document.getElementById('smtpHost').value;
  const smtpPort = document.getElementById('smtpPort').value;
  const emailFromName = document.getElementById('emailFromName').value;
  const emailFromAddress = document.getElementById('emailFromAddress').value;
  const emailEnabled = document.getElementById('emailEnabled').checked;

  // 入力チェック
  if (!smtpHost || !smtpPort || !emailFromAddress) {
    alert('❌ エラー\n\nSMTPサーバー、ポート、送信者アドレスを入力してください。');
    return;
  }

  if (!emailEnabled) {
    if (!confirm('メール通知が無効になっています。\nそれでもテストメールを送信しますか？')) {
      return;
    }
  }

  // テストメール送信のシミュレーション
  console.log('Test email configuration:', {
    smtpHost,
    smtpPort,
    emailFromName,
    emailFromAddress,
    to: 'test@example.com',
    subject: 'テストメール - 施設予約システム',
    body: 'これはメール設定のテストメールです。'
  });

  // 成功メッセージ
  alert('✅ テストメールを送信しました\n\n' +
        '送信先: test@example.com\n' +
        '件名: テストメール - 施設予約システム\n\n' +
        '※ デモサイトのため、実際にはメールは送信されていません。\n' +
        '本番環境では、設定したSMTPサーバーを通じてメールが送信されます。');
}

// 営業時間を保存
async function saveBusinessHours() {
  const days = ['月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日', '日曜日'];
  const businessHours = days.map((day, index) => ({
    day,
    open: document.getElementById(`dayOpen_${index}`).checked,
    startTime: document.getElementById(`dayStart_${index}`).value,
    endTime: document.getElementById(`dayEnd_${index}`).value
  }));

  try {
    const res = await fetch('/api/staff/settings/business-hours', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ businessHours })
    });

    if (res.ok) {
      alert('営業時間を保存しました');
    } else {
      const error = await res.json();
      alert('保存に失敗しました: ' + (error.error || '不明なエラー'));
    }
  } catch (error) {
    console.error('Error saving business hours:', error);
    alert('保存に失敗しました');
  }
}

// バックアップ作成
function createBackup() {
  if (!confirm('データベースの完全バックアップを作成しますか？\nこの処理には数分かかる場合があります。')) {
    return;
  }

  alert('バックアップを作成しました（デモモード）\n実際の実装ではサーバー側でバックアップファイルが作成されます。');
}

// 古いデータのクリーンアップ
function cleanupOldData() {
  if (!confirm('1年以上前のキャンセル済み予約を削除しますか？\nこの操作は取り消せません。')) {
    return;
  }

  alert('クリーンアップを実行しました（デモモード）\n削除件数: 0件');
}

// ログのエクスポート
function exportLogs() {
  alert('システムログをエクスポートしています（デモモード）\n実際の実装ではCSVファイルがダウンロードされます。');
}

// 危険な操作: 予約リセット
function resetReservations() {
  const confirmation = prompt('すべての予約データを削除します。\n実行するには「RESET」と入力してください:');
  if (confirmation !== 'RESET') {
    alert('キャンセルしました');
    return;
  }

  alert('予約データをリセットしました（デモモード）\nこの機能は実際の運用では使用しないでください。');
}

// 危険な操作: ユーザーリセット
function resetUsers() {
  const confirmation = prompt('職員を除くすべてのユーザーアカウントを削除します。\n実行するには「RESET」と入力してください:');
  if (confirmation !== 'RESET') {
    alert('キャンセルしました');
    return;
  }

  alert('ユーザーデータをリセットしました（デモモード）\nこの機能は実際の運用では使用しないでください。');
}
</script>
