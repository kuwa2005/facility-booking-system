<div class="page-header">
  <h1 class="page-title">ä¼‘é¤¨æ—¥ç®¡ç†</h1>
  <p class="page-description">æ–½è¨­ã®ä¼‘é¤¨æ—¥ã®ç™»éŒ²ã€å‰Šé™¤</p>
</div>

<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
<div style="display: grid; grid-template-columns: 1fr 400px; gap: 1.5rem;">
  <!-- ä¼‘é¤¨æ—¥ä¸€è¦§ -->
  <div class="card">
    <h2 class="card-title">ç™»éŒ²æ¸ˆã¿ä¼‘é¤¨æ—¥</h2>
    <div id="closedDatesContainer">
      <p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>

  <!-- è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="card" style="position: sticky; top: 2rem; height: fit-content;">
    <h2 class="card-title">ä¼‘é¤¨æ—¥ã‚’è¿½åŠ </h2>
    <form id="addForm" style="display: grid; gap: 1rem;">
      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æ—¥ä»˜ *</label>
        <input type="date" id="closedDate" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
      </div>

      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ç†ç”±</label>
        <textarea id="reason" rows="3" placeholder="ä¾‹: å¹´æœ«å¹´å§‹ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
      </div>

      <button type="submit" class="btn btn-primary" style="width: 100%;">ä¼‘é¤¨æ—¥ã‚’è¿½åŠ </button>
    </form>

    <div style="margin-top: 1.5rem; padding: 1rem; background-color: #d1ecf1; border-radius: 4px; border-left: 4px solid #0c5460;">
      <h3 style="font-size: 0.875rem; color: #0c5460; margin-bottom: 0.5rem;">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</h3>
      <p style="font-size: 0.875rem; color: #0c5460; margin: 0;">
        ä¼‘é¤¨æ—¥ã«ç™»éŒ²ã•ã‚ŒãŸæ—¥ã¯ã€åˆ©ç”¨è€…ãŒäºˆç´„ã§ããªããªã‚Šã¾ã™ã€‚å¹´æœ«å¹´å§‹ã€ç¥æ—¥ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ—¥ãªã©ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
      </p>
    </div>
  </div>
</div>

<!-- å¹´æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
<div class="card" style="margin-top: 1.5rem;">
  <div style="display: flex; gap: 1rem; align-items: center; justify-content: center;">
    <button onclick="changeMonth(-1)" class="btn" style="background-color: #95a5a6; color: white;">
      â† å‰æœˆ
    </button>
    <h3 id="currentMonthDisplay" style="margin: 0; min-width: 150px; text-align: center;"></h3>
    <button onclick="changeMonth(1)" class="btn" style="background-color: #95a5a6; color: white;">
      æ¬¡æœˆ â†’
    </button>
    <button onclick="resetToThisMonth()" class="btn btn-primary">ä»Šæœˆ</button>
  </div>

  <div id="monthlyCalendar" style="margin-top: 1.5rem;"></div>
</div>

<script>

let allClosedDates = [];
let currentViewYear = new Date().getFullYear();
let currentViewMonth = new Date().getMonth();

// åˆæœŸãƒ­ãƒ¼ãƒ‰
document.addEventListener('DOMContentLoaded', () => {
  loadClosedDates();

  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById('addForm').addEventListener('submit', (e) => {
    e.preventDefault();
    addClosedDate();
  });

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜ã‚’ä»Šæ—¥ã«è¨­å®š
  document.getElementById('closedDate').valueAsDate = new Date();
});

// ä¼‘é¤¨æ—¥ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
async function loadClosedDates() {
  try {
    const res = await fetch('/api/staff/facilities/closed-dates', {
      credentials: 'include',
      });
    allClosedDates = await res.json();
    displayClosedDates();
    renderMonthlyCalendar();
  } catch (error) {
    console.error('Error loading closed dates:', error);
    document.getElementById('closedDatesContainer').innerHTML = '<p style="text-align: center; color: #e74c3c;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
  }
}

// ä¼‘é¤¨æ—¥ã‚’è¡¨ç¤º
function displayClosedDates() {
  if (allClosedDates && allClosedDates.length > 0) {
    // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
    const sorted = [...allClosedDates].sort((a, b) => new Date(a.date) - new Date(b.date));

    const html = `
      <div style="max-height: 500px; overflow-y: auto;">
        <table class="table">
          <thead>
            <tr>
              <th>æ—¥ä»˜</th>
              <th>æ›œæ—¥</th>
              <th>ç†ç”±</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${sorted.map(cd => {
              const date = new Date(cd.date);
              const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
              const dayName = dayNames[date.getDay()];
              const isWeekend = date.getDay() === 0 || date.getDay() === 6;

              return `
                <tr>
                  <td>${date.toLocaleDateString('ja-JP')}</td>
                  <td>
                    <span style="color: ${isWeekend ? '#e74c3c' : '#333'}; font-weight: ${isWeekend ? '600' : 'normal'};">
                      ${dayName}
                    </span>
                  </td>
                  <td>${cd.reason || '-'}</td>
                  <td>
                    <button onclick="deleteClosedDate(${cd.id})" class="btn btn-danger" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">å‰Šé™¤</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;
    document.getElementById('closedDatesContainer').innerHTML = html;
  } else {
    document.getElementById('closedDatesContainer').innerHTML = '<p style="text-align: center; color: #7f8c8d;">ä¼‘é¤¨æ—¥ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
  }
}

// ä¼‘é¤¨æ—¥ã‚’è¿½åŠ 
async function addClosedDate() {
  const date = document.getElementById('closedDate').value;
  const reason = document.getElementById('reason').value.trim();

  if (!date) {
    alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }

  try {
    const res = await fetch('/api/staff/facilities/closed-dates', {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ date, reason })
    });

    if (res.ok) {
      alert('ä¼‘é¤¨æ—¥ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      document.getElementById('reason').value = '';
      // æ¬¡ã®æ—¥ã«æ—¥ä»˜ã‚’é€²ã‚ã‚‹
      const nextDate = new Date(date);
      nextDate.setDate(nextDate.getDate() + 1);
      document.getElementById('closedDate').valueAsDate = nextDate;
      loadClosedDates();
    } else {
      const error = await res.json();
      alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }
  } catch (error) {
    console.error('Error adding closed date:', error);
    alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ä¼‘é¤¨æ—¥ã‚’å‰Šé™¤
async function deleteClosedDate(id) {
  if (!confirm('ã“ã®ä¼‘é¤¨æ—¥ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    return;
  }

  try {
    const res = await fetch(`/api/staff/facilities/closed-dates/${id}`, {
      method: 'DELETE',
      credentials: 'include',
      });

    if (res.ok) {
      alert('ä¼‘é¤¨æ—¥ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      loadClosedDates();
    } else {
      const error = await res.json();
      alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }
  } catch (error) {
    console.error('Error deleting closed date:', error);
    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// æœˆæ¬¡ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¡¨ç¤º
function renderMonthlyCalendar() {
  const year = currentViewYear;
  const month = currentViewMonth;

  // æœˆã®è¡¨ç¤ºå
  document.getElementById('currentMonthDisplay').textContent = `${year}å¹´ ${month + 1}æœˆ`;

  // æœˆã®æœ€åˆã®æ—¥ã¨æœ€å¾Œã®æ—¥
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startDayOfWeek = firstDay.getDay(); // 0 = æ—¥æ›œæ—¥

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ã‚’ä½œæˆ
  let calendarHTML = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;">';

  // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
  const dayHeaders = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
  dayHeaders.forEach((day, index) => {
    const isWeekend = index === 0 || index === 6;
    calendarHTML += `<div style="text-align: center; font-weight: 600; padding: 0.5rem; color: ${isWeekend ? '#e74c3c' : '#333'};">${day}</div>`;
  });

  // ç©ºç™½ã‚»ãƒ«ï¼ˆæœˆã®æœ€åˆã®æ—¥ã¾ã§ï¼‰
  for (let i = 0; i < startDayOfWeek; i++) {
    calendarHTML += '<div></div>';
  }

  // æ—¥ä»˜ã‚»ãƒ«
  for (let day = 1; day <= daysInMonth; day++) {
    const currentDate = new Date(year, month, day);
    const dateString = currentDate.toISOString().split('T')[0];
    const isClosed = allClosedDates.some(cd => cd.date.startsWith(dateString));
    const isToday = new Date().toDateString() === currentDate.toDateString();
    const dayOfWeek = currentDate.getDay();
    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

    let bgColor = '#fff';
    let textColor = '#333';
    let border = '1px solid #ddd';

    if (isClosed) {
      bgColor = '#f8d7da';
      textColor = '#721c24';
      border = '2px solid #e74c3c';
    } else if (isToday) {
      border = '2px solid #3498db';
    }

    if (isWeekend && !isClosed) {
      textColor = '#e74c3c';
    }

    calendarHTML += `
      <div style="
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: ${bgColor};
        color: ${textColor};
        border: ${border};
        border-radius: 4px;
        font-weight: ${isClosed ? '700' : isToday ? '600' : 'normal'};
        position: relative;
        cursor: ${isClosed ? 'pointer' : 'default'};
      " ${isClosed ? `title="ä¼‘é¤¨æ—¥"` : ''}>
        ${day}
        ${isClosed ? '<div style="position: absolute; bottom: 2px; font-size: 0.7rem;">ğŸ”’</div>' : ''}
      </div>
    `;
  }

  calendarHTML += '</div>';

  // å‡¡ä¾‹
  calendarHTML += `
    <div style="display: flex; gap: 2rem; justify-content: center; margin-top: 1.5rem; font-size: 0.875rem;">
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <div style="width: 20px; height: 20px; background-color: #f8d7da; border: 2px solid #e74c3c; border-radius: 4px;"></div>
        <span>ä¼‘é¤¨æ—¥</span>
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <div style="width: 20px; height: 20px; background-color: #fff; border: 2px solid #3498db; border-radius: 4px;"></div>
        <span>æœ¬æ—¥</span>
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <div style="width: 20px; height: 20px; background-color: #fff; border: 1px solid #ddd; border-radius: 4px; color: #e74c3c; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">æ—¥</div>
        <span>åœŸæ—¥</span>
      </div>
    </div>
  `;

  document.getElementById('monthlyCalendar').innerHTML = calendarHTML;
}

// æœˆã‚’å¤‰æ›´
function changeMonth(delta) {
  currentViewMonth += delta;
  if (currentViewMonth < 0) {
    currentViewMonth = 11;
    currentViewYear--;
  } else if (currentViewMonth > 11) {
    currentViewMonth = 0;
    currentViewYear++;
  }
  renderMonthlyCalendar();
}

// ä»Šæœˆã«æˆ»ã‚‹
function resetToThisMonth() {
  currentViewYear = new Date().getFullYear();
  currentViewMonth = new Date().getMonth();
  renderMonthlyCalendar();
}
</script>
