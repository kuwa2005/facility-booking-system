<div class="page-header">
  <h1 class="page-title">åˆ©ç”¨è¨˜éŒ²ç®¡ç†</h1>
  <p class="page-description">ç©ºèª¿æ™‚é–“ã®å…¥åŠ›ã€å®Ÿç¸¾ç®¡ç†ã€æ‘˜è¦æ¬„ã®ç·¨é›†</p>
</div>

<!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
  <button onclick="loadTodayUsages()" class="btn btn-primary" style="padding: 1rem;">
    ğŸ“… æœ¬æ—¥ã®åˆ©ç”¨
  </button>
  <button onclick="loadMissingAcHours()" class="btn" style="padding: 1rem; background-color: #e67e22; color: white;">
    âš ï¸ ACæ™‚é–“æœªå…¥åŠ›
  </button>
  <button onclick="showDateRangeSearch()" class="btn" style="padding: 1rem; background-color: #9b59b6; color: white;">
    ğŸ” æœŸé–“æ¤œç´¢
  </button>
</div>

<!-- æœŸé–“æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
<div id="dateRangeForm" class="card" style="display: none;">
  <h3 style="margin-bottom: 1rem;">æœŸé–“ã‚’æŒ‡å®šã—ã¦æ¤œç´¢</h3>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
    <div>
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">é–‹å§‹æ—¥</label>
      <input type="date" id="rangeStartDate" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    <div>
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">çµ‚äº†æ—¥</label>
      <input type="date" id="rangeEndDate" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    <div style="display: flex; align-items: flex-end;">
      <button onclick="loadDateRangeUsages()" class="btn btn-primary" style="width: 100%;">æ¤œç´¢</button>
    </div>
  </div>
</div>

<!-- åˆ©ç”¨è¨˜éŒ²ä¸€è¦§ -->
<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h2 class="card-title" style="margin: 0;" id="listTitle">åˆ©ç”¨è¨˜éŒ²ä¸€è¦§</h2>
    <div style="display: flex; gap: 1rem; align-items: center;">
      <div id="totalCount" style="color: #7f8c8d;"></div>
      <button onclick="exportToCSV()" class="btn" style="background-color: #27ae60; color: white;">ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    </div>
  </div>
  <div id="usagesContainer">
    <p style="text-align: center; color: #7f8c8d;">ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰æ¤œç´¢ã—ã¦ãã ã•ã„</p>
  </div>
</div>

<!-- åˆ©ç”¨è¨˜éŒ²ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
  <div style="background-color: white; max-width: 800px; margin: 2rem auto; border-radius: 8px; padding: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="margin: 0;">åˆ©ç”¨è¨˜éŒ²ç·¨é›†</h2>
      <button onclick="closeEditModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
    </div>
    <div id="editContent"></div>
  </div>
</div>

<script>

let currentUsageId = null;
let currentUsages = [];

// ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
document.addEventListener('DOMContentLoaded', () => {
  const today = new Date();
  document.getElementById('rangeStartDate').valueAsDate = today;
  document.getElementById('rangeEndDate').valueAsDate = today;
});

// æœ¬æ—¥ã®åˆ©ç”¨ã‚’èª­ã¿è¾¼ã¿
async function loadTodayUsages() {
  document.getElementById('dateRangeForm').style.display = 'none';
  document.getElementById('listTitle').textContent = 'æœ¬æ—¥ã®åˆ©ç”¨';

  try {
    const res = await fetch('/api/staff/usages/today/all', {
      credentials: 'include',
      });
    const usages = await res.json();

    displayUsages(usages);
  } catch (error) {
    console.error('Error loading today usages:', error);
    document.getElementById('usagesContainer').innerHTML = '<p style="text-align: center; color: #e74c3c;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
  }
}

// ACæ™‚é–“æœªå…¥åŠ›ã‚’èª­ã¿è¾¼ã¿
async function loadMissingAcHours() {
  document.getElementById('dateRangeForm').style.display = 'none';
  document.getElementById('listTitle').textContent = 'ACæ™‚é–“æœªå…¥åŠ›';

  try {
    const res = await fetch('/api/staff/usages/missing-ac-hours/all', {
      credentials: 'include',
      });
    const usages = await res.json();

    displayUsages(usages);
  } catch (error) {
    console.error('Error loading missing AC hours:', error);
    document.getElementById('usagesContainer').innerHTML = '<p style="text-align: center; color: #e74c3c;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
  }
}

// æœŸé–“æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
function showDateRangeSearch() {
  const form = document.getElementById('dateRangeForm');
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

// æœŸé–“æŒ‡å®šã§èª­ã¿è¾¼ã¿
async function loadDateRangeUsages() {
  const startDate = document.getElementById('rangeStartDate').value;
  const endDate = document.getElementById('rangeEndDate').value;

  if (!startDate || !endDate) {
    alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
    return;
  }

  document.getElementById('listTitle').textContent = `æœŸé–“: ${startDate} ï½ ${endDate}`;

  try {
    const params = new URLSearchParams({ startDate, endDate });
    const res = await fetch(`/api/staff/usages/date-range/all?${params}`, {
      credentials: 'include',
      });
    const usages = await res.json();

    displayUsages(usages);
  } catch (error) {
    console.error('Error loading date range usages:', error);
    document.getElementById('usagesContainer').innerHTML = '<p style="text-align: center; color: #e74c3c;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
  }
}

// åˆ©ç”¨è¨˜éŒ²ã‚’è¡¨ç¤º
function displayUsages(usages) {
  // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ã«ä¿å­˜
  currentUsages = usages || [];

  if (usages && usages.length > 0) {
    document.getElementById('totalCount').textContent = `å…¨ ${usages.length} ä»¶`;

    const html = `
      <div style="overflow-x: auto;">
        <table class="table">
          <thead>
            <tr>
              <th>æ—¥ä»˜</th>
              <th>æ–½è¨­</th>
              <th>ã‚¤ãƒ™ãƒ³ãƒˆå</th>
              <th>æ™‚é–“å¸¯</th>
              <th>ACè¦å¦</th>
              <th>ACæ™‚é–“</th>
              <th>é‡‘é¡</th>
              <th>æ‘˜è¦</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${usages.map(usage => {
              const slots = [];
              if (usage.useMorning) slots.push('åˆå‰');
              if (usage.useMiddayExtension) slots.push('æ­£åˆå»¶é•·');
              if (usage.useAfternoon) slots.push('åˆå¾Œ');
              if (usage.useEveningExtension) slots.push('å¤•æ–¹å»¶é•·');
              if (usage.useEvening) slots.push('å¤œé–“');

              const acStatus = !usage.acRequested ? '-' :
                              usage.acHours ? `${usage.acHours}æ™‚é–“` :
                              '<span class="badge badge-warning">æœªå…¥åŠ›</span>';

              return `
                <tr>
                  <td>${new Date(usage.date).toLocaleDateString('ja-JP')}</td>
                  <td>${usage.roomName || '-'}</td>
                  <td>${usage.eventName || '-'}</td>
                  <td style="font-size: 0.875rem;">${slots.join(', ')}</td>
                  <td>
                    <span class="badge badge-${usage.acRequested ? 'info' : 'secondary'}" style="${!usage.acRequested ? 'background-color: #95a5a6;' : ''}">
                      ${usage.acRequested ? 'è¦' : 'ä¸è¦'}
                    </span>
                  </td>
                  <td>${acStatus}</td>
                  <td>Â¥${(usage.subtotalAmount || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0})}</td>
                  <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${usage.remarks || '-'}
                  </td>
                  <td>
                    <button onclick="showEditModal(${usage.id})" class="btn btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">ç·¨é›†</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;
    document.getElementById('usagesContainer').innerHTML = html;
  } else {
    document.getElementById('totalCount').textContent = '';
    document.getElementById('usagesContainer').innerHTML = '<p style="text-align: center; color: #7f8c8d;">åˆ©ç”¨è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
  }
}

// ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
async function showEditModal(id) {
  currentUsageId = id;

  try {
    const res = await fetch(`/api/staff/usages/${id}`, {
      credentials: 'include',
      });
    const usage = await res.json();

    const slots = [];
    if (usage.useMorning) slots.push('åˆå‰');
    if (usage.useMiddayExtension) slots.push('æ­£åˆå»¶é•·');
    if (usage.useAfternoon) slots.push('åˆå¾Œ');
    if (usage.useEveningExtension) slots.push('å¤•æ–¹å»¶é•·');
    if (usage.useEvening) slots.push('å¤œé–“');

    const html = `
      <div style="display: grid; gap: 1.5rem;">
        <!-- åŸºæœ¬æƒ…å ± -->
        <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
          <h3 style="margin-bottom: 1rem; color: #2c3e50;">åŸºæœ¬æƒ…å ±</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div>
              <strong>åˆ©ç”¨æ—¥:</strong> ${new Date(usage.date).toLocaleDateString('ja-JP')}
            </div>
            <div>
              <strong>æ–½è¨­:</strong> ${usage.roomName || '-'}
            </div>
            <div>
              <strong>ã‚¤ãƒ™ãƒ³ãƒˆå:</strong> ${usage.eventName || '-'}
            </div>
            <div>
              <strong>æ™‚é–“å¸¯:</strong> ${slots.join(', ')}
            </div>
            <div>
              <strong>ç”³è«‹è€…:</strong> ${usage.applicantName || '-'}
            </div>
            <div>
              <strong>ç”³è«‹ID:</strong> ${usage.applicationId}
            </div>
          </div>
        </div>

        <!-- æ–™é‡‘æƒ…å ± -->
        <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
          <h3 style="margin-bottom: 1rem; color: #2c3e50;">æ–™é‡‘æƒ…å ±</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div>
              <strong>æ–½è¨­æ–™é‡‘ï¼ˆä¹—æ•°å‰ï¼‰:</strong> Â¥${(usage.roomBaseChargeBeforeMultiplier || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0})}
            </div>
            <div>
              <strong>æ–½è¨­æ–™é‡‘ï¼ˆä¹—æ•°å¾Œï¼‰:</strong> Â¥${(usage.roomChargeAfterMultiplier || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0})}
            </div>
            <div>
              <strong>è¨­å‚™æ–™é‡‘:</strong> Â¥${(usage.equipmentCharge || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0})}
            </div>
            <div>
              <strong>ç©ºèª¿æ–™é‡‘:</strong> Â¥${(usage.acCharge || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0})}
            </div>
            <div style="grid-column: 1 / -1;">
              <strong style="font-size: 1.1rem;">å°è¨ˆ:</strong>
              <span style="font-size: 1.25rem; color: #3498db; font-weight: 600;">Â¥${(usage.subtotalAmount || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0})}</span>
            </div>
          </div>
        </div>

        <!-- ç©ºèª¿æ™‚é–“å…¥åŠ› -->
        ${usage.acRequested ? `
          <div style="padding: 1rem; background-color: #fff3cd; border-radius: 4px; border: 2px solid #f39c12;">
            <h3 style="margin-bottom: 1rem; color: #2c3e50;">ç©ºèª¿ä½¿ç”¨æ™‚é–“</h3>
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: end;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ç©ºèª¿ä½¿ç”¨æ™‚é–“ï¼ˆæ™‚é–“ï¼‰</label>
                <input type="number" id="acHours" value="${usage.acHours || ''}" step="0.5" min="0" placeholder="ä¾‹: 3.5" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
              </div>
              <button onclick="updateAcHours()" class="btn btn-success">ACæ™‚é–“ã‚’æ›´æ–°</button>
            </div>
            <p style="margin-top: 0.5rem; font-size: 0.875rem; color: #856404;">â€» 0.5æ™‚é–“å˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 3, 3.5, 4ï¼‰</p>
          </div>
        ` : '<div style="padding: 1rem; background-color: #d4edda; border-radius: 4px; text-align: center; color: #155724;">ã“ã®åˆ©ç”¨ã§ã¯ç©ºèª¿ã¯ä½¿ç”¨ã•ã‚Œã¾ã›ã‚“</div>'}

        <!-- å®Ÿéš›ã®åˆ©ç”¨æ™‚é–“ -->
        <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
          <h3 style="margin-bottom: 1rem; color: #2c3e50;">å®Ÿéš›ã®åˆ©ç”¨æ™‚é–“</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">é–‹å§‹æ™‚åˆ»</label>
              <input type="time" id="actualStartTime" value="${usage.actualStartTime || ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">çµ‚äº†æ™‚åˆ»</label>
              <input type="time" id="actualEndTime" value="${usage.actualEndTime || ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <button onclick="updateActualTime()" class="btn btn-primary">å®Ÿç¸¾ã‚’æ›´æ–°</button>
          </div>
        </div>

        <!-- æ‘˜è¦æ¬„ -->
        <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
          <h3 style="margin-bottom: 1rem; color: #2c3e50;">æ‘˜è¦æ¬„</h3>
          <textarea id="remarks" rows="4" placeholder="å‚™è€ƒã‚„ç‰¹è¨˜äº‹é …ã‚’å…¥åŠ›..." style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${usage.remarks || ''}</textarea>
          <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
            <button onclick="updateRemarks()" class="btn btn-primary">æ‘˜è¦ã‚’æ›´æ–°</button>
          </div>
        </div>

        <!-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
        <div style="display: flex; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #ecf0f1;">
          <button onclick="closeEditModal()" class="btn" style="background-color: #95a5a6; color: white;">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    `;

    document.getElementById('editContent').innerHTML = html;
    document.getElementById('editModal').style.display = 'block';
  } catch (error) {
    console.error('Error loading usage detail:', error);
    alert('åˆ©ç”¨è¨˜éŒ²ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
  currentUsageId = null;
}

// ACæ™‚é–“ã‚’æ›´æ–°
async function updateAcHours() {
  if (!currentUsageId) return;

  const acHours = parseFloat(document.getElementById('acHours').value);
  if (isNaN(acHours) || acHours < 0) {
    alert('æœ‰åŠ¹ãªæ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  try {
    const res = await fetch(`/api/staff/usages/${currentUsageId}/ac-hours`, {
      method: 'PATCH',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ acHours })
    });

    if (res.ok) {
      alert('ç©ºèª¿æ™‚é–“ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      closeEditModal();
      // æœ€å¾Œã«è¡¨ç¤ºã—ã¦ã„ãŸãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
      const title = document.getElementById('listTitle').textContent;
      if (title.includes('æœ¬æ—¥')) {
        loadTodayUsages();
      } else if (title.includes('æœªå…¥åŠ›')) {
        loadMissingAcHours();
      }
    } else {
      const error = await res.json();
      alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }
  } catch (error) {
    console.error('Error updating AC hours:', error);
    alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// å®Ÿéš›ã®åˆ©ç”¨æ™‚é–“ã‚’æ›´æ–°
async function updateActualTime() {
  if (!currentUsageId) return;

  const actualStartTime = document.getElementById('actualStartTime').value;
  const actualEndTime = document.getElementById('actualEndTime').value;

  if (!actualStartTime || !actualEndTime) {
    alert('é–‹å§‹æ™‚åˆ»ã¨çµ‚äº†æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  try {
    const res = await fetch(`/api/staff/usages/${currentUsageId}/actual-time`, {
      method: 'PATCH',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ actualStartTime, actualEndTime })
    });

    if (res.ok) {
      alert('å®Ÿéš›ã®åˆ©ç”¨æ™‚é–“ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
    } else {
      const error = await res.json();
      alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }
  } catch (error) {
    console.error('Error updating actual time:', error);
    alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// æ‘˜è¦ã‚’æ›´æ–°
async function updateRemarks() {
  if (!currentUsageId) return;

  const remarks = document.getElementById('remarks').value.trim();

  try {
    const res = await fetch(`/api/staff/usages/${currentUsageId}/remarks`, {
      method: 'PATCH',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ remarks })
    });

    if (res.ok) {
      alert('æ‘˜è¦ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
    } else {
      const error = await res.json();
      alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }
  } catch (error) {
    console.error('Error updating remarks:', error);
    alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('editModal').addEventListener('click', (e) => {
  if (e.target.id === 'editModal') {
    closeEditModal();
  }
});

// CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
function exportToCSV() {
  if (!currentUsages || currentUsages.length === 0) {
    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  // CSVãƒ˜ãƒƒãƒ€ãƒ¼
  const headers = ['æ—¥ä»˜', 'æ–½è¨­', 'ã‚¤ãƒ™ãƒ³ãƒˆå', 'æ™‚é–“å¸¯', 'ACè¦å¦', 'ACæ™‚é–“', 'é‡‘é¡', 'æ‘˜è¦'];

  // CSVãƒ‡ãƒ¼ã‚¿è¡Œ
  const rows = currentUsages.map(usage => {
    const slots = [];
    if (usage.useMorning) slots.push('åˆå‰');
    if (usage.useMiddayExtension) slots.push('æ­£åˆå»¶é•·');
    if (usage.useAfternoon) slots.push('åˆå¾Œ');
    if (usage.useEveningExtension) slots.push('å¤•æ–¹å»¶é•·');
    if (usage.useEvening) slots.push('å¤œé–“');

    const acRequired = usage.acRequested ? 'è¦' : 'ä¸è¦';
    const acHours = usage.acRequested ? (usage.acHours || 'æœªå…¥åŠ›') : '-';

    return [
      new Date(usage.date).toLocaleDateString('ja-JP'),
      usage.roomName || '-',
      usage.eventName || '-',
      slots.join(' / '),
      acRequired,
      acHours,
      usage.subtotalAmount || 0,
      usage.remarks || '-'
    ];
  });

  // CSVå½¢å¼ã«å¤‰æ›
  const csvContent = [
    headers.join(','),
    ...rows.map(row => row.map(cell => {
      // ã‚»ãƒ«å†…ã«ã‚«ãƒ³ãƒã‚„æ”¹è¡ŒãŒã‚ã‚‹å ´åˆã¯ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€
      const cellStr = String(cell);
      if (cellStr.includes(',') || cellStr.includes('\n') || cellStr.includes('"')) {
        return '"' + cellStr.replace(/"/g, '""') + '"';
      }
      return cellStr;
    }).join(','))
  ].join('\n');

  // BOMä»˜ãUTF-8ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆExcelã§æ–‡å­—åŒ–ã‘ã—ãªã„ã‚ˆã†ã«ï¼‰
  const bom = '\uFEFF';
  const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });

  // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ã‚¯ãƒªãƒƒã‚¯
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  const now = new Date();
  const filename = `usages_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}.csv`;

  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>
