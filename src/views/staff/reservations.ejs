<div class="page-header">
  <h1 class="page-title">äºˆç´„ç®¡ç†</h1>
  <p class="page-description">äºˆç´„ã®ç¢ºèªã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€æ±ºæ¸ˆçŠ¶æ³ã®ç®¡ç†</p>
</div>

<!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
<div class="card">
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
    <div>
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">é–‹å§‹æ—¥</label>
      <input type="date" id="startDate" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    <div>
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">çµ‚äº†æ—¥</label>
      <input type="date" id="endDate" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    <div>
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æ±ºæ¸ˆçŠ¶æ³</label>
      <select id="paymentStatus" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">ã™ã¹ã¦</option>
        <option value="unpaid">æœªæ±ºæ¸ˆ</option>
        <option value="paid">æ”¯æ‰•æ¸ˆ</option>
        <option value="refunded">è¿”é‡‘æ¸ˆ</option>
      </select>
    </div>
    <div>
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«çŠ¶æ³</label>
      <select id="cancelStatus" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">ã™ã¹ã¦</option>
        <option value="none">æœ‰åŠ¹</option>
        <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆ</option>
      </select>
    </div>
  </div>
  <div style="display: flex; gap: 1rem;">
    <input type="text" id="searchText" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆåã€ç”³è«‹è€…åã§æ¤œç´¢..." style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
    <button onclick="loadReservations()" class="btn btn-primary">æ¤œç´¢</button>
    <button onclick="resetFilters()" class="btn" style="background-color: #95a5a6; color: white;">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<!-- äºˆç´„ä¸€è¦§ -->
<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h2 class="card-title" style="margin: 0;">äºˆç´„ä¸€è¦§</h2>
    <div style="display: flex; gap: 1rem; align-items: center;">
      <div id="totalCount" style="color: #7f8c8d;"></div>
      <button onclick="exportToCSV()" class="btn" style="background-color: #27ae60; color: white;">ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    </div>
  </div>
  <div id="reservationsContainer">
    <p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>
</div>

<!-- äºˆç´„è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="detailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
  <div style="background-color: white; max-width: 900px; margin: 2rem auto; border-radius: 8px; padding: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="margin: 0;">äºˆç´„è©³ç´°</h2>
      <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
    </div>
    <div id="detailContent"></div>
  </div>
</div>

<!-- ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="noteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1001; overflow-y: auto;">
  <div style="background-color: white; max-width: 600px; margin: 2rem auto; border-radius: 8px; padding: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="margin: 0;">ãƒ¡ãƒ¢ç®¡ç†</h2>
      <button onclick="closeNoteModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
    </div>
    <div id="noteContent"></div>
  </div>
</div>

<script>

let currentReservationId = null;
let currentReservations = [];

// åˆæœŸãƒ­ãƒ¼ãƒ‰
document.addEventListener('DOMContentLoaded', () => {
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä»Šæœˆã®ç¯„å›²ã‚’è¨­å®š
  const today = new Date();
  const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
  const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

  document.getElementById('startDate').valueAsDate = firstDay;
  document.getElementById('endDate').valueAsDate = lastDay;

  loadReservations();
});

// äºˆç´„ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
async function loadReservations() {
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const paymentStatus = document.getElementById('paymentStatus').value;
  const cancelStatus = document.getElementById('cancelStatus').value;
  const searchText = document.getElementById('searchText').value;

  const params = new URLSearchParams();
  if (startDate) params.append('startDate', startDate);
  if (endDate) params.append('endDate', endDate);
  if (paymentStatus) params.append('paymentStatus', paymentStatus);
  if (cancelStatus) params.append('cancelStatus', cancelStatus);
  if (searchText) params.append('search', searchText);

  try {
    const res = await fetch(`/api/staff/reservations?${params}`, {
      credentials: 'include',
      });
    const data = await res.json();

    // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ã«ä¿å­˜
    currentReservations = data.reservations || [];

    if (data.reservations && data.reservations.length > 0) {
      document.getElementById('totalCount').textContent = `å…¨ ${data.reservations.length} ä»¶`;

      const html = `
        <div style="overflow-x: auto;">
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>ã‚¤ãƒ™ãƒ³ãƒˆå</th>
                <th>ç”³è«‹è€…</th>
                <th>åˆ©ç”¨æ—¥</th>
                <th>æ–½è¨­</th>
                <th>é‡‘é¡</th>
                <th>æ±ºæ¸ˆçŠ¶æ³</th>
                <th>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${data.reservations.map(res => `
                <tr>
                  <td>${res.id}</td>
                  <td>${res.eventName || '-'}</td>
                  <td>${res.applicantName || '-'}</td>
                  <td>${res.usageDates ? res.usageDates.join(', ') : '-'}</td>
                  <td>${res.rooms ? res.rooms.join(', ') : '-'}</td>
                  <td>Â¥${(res.totalAmount || 0).toLocaleString()}</td>
                  <td>
                    <span class="badge badge-${res.paymentStatus === 'paid' ? 'success' : res.paymentStatus === 'unpaid' ? 'warning' : 'info'}">
                      ${res.paymentStatus === 'paid' ? 'æ”¯æ‰•æ¸ˆ' : res.paymentStatus === 'unpaid' ? 'æœªæ±ºæ¸ˆ' : 'è¿”é‡‘æ¸ˆ'}
                    </span>
                  </td>
                  <td>
                    <span class="badge badge-${res.cancelStatus === 'cancelled' ? 'danger' : 'success'}">
                      ${res.cancelStatus === 'cancelled' ? 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆ' : 'æœ‰åŠ¹'}
                    </span>
                  </td>
                  <td>
                    <button onclick="showDetail(${res.id})" class="btn btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">è©³ç´°</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      document.getElementById('reservationsContainer').innerHTML = html;
    } else {
      document.getElementById('totalCount').textContent = '';
      document.getElementById('reservationsContainer').innerHTML = '<p style="text-align: center; color: #7f8c8d;">äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    }
  } catch (error) {
    console.error('Error loading reservations:', error);
    document.getElementById('reservationsContainer').innerHTML = '<p style="text-align: center; color: #e74c3c;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
  }
}

// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
function resetFilters() {
  const today = new Date();
  const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
  const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

  document.getElementById('startDate').valueAsDate = firstDay;
  document.getElementById('endDate').valueAsDate = lastDay;
  document.getElementById('paymentStatus').value = '';
  document.getElementById('cancelStatus').value = '';
  document.getElementById('searchText').value = '';

  loadReservations();
}

// äºˆç´„è©³ç´°ã‚’è¡¨ç¤º
async function showDetail(id) {
  currentReservationId = id;

  try {
    const res = await fetch(`/api/staff/reservations/${id}`, {
      credentials: 'include',
      });
    const reservation = await res.json();

    const usages = reservation.usages || [];
    const canCancel = reservation.cancelStatus !== 'cancelled';
    const canUpdatePayment = reservation.cancelStatus !== 'cancelled';

    const html = `
      <div style="display: grid; gap: 1.5rem;">
        <!-- åŸºæœ¬æƒ…å ± -->
        <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
          <h3 style="margin-bottom: 1rem; color: #2c3e50;">åŸºæœ¬æƒ…å ±</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div>
              <strong>ç”³è«‹ID:</strong> ${reservation.id}
            </div>
            <div>
              <strong>ç”³è«‹æ—¥:</strong> ${new Date(reservation.createdAt).toLocaleDateString('ja-JP')}
            </div>
            <div>
              <strong>ã‚¤ãƒ™ãƒ³ãƒˆå:</strong> ${reservation.eventName || '-'}
            </div>
            <div>
              <strong>äºˆæƒ³å‚åŠ è€…æ•°:</strong> ${reservation.expectedAttendees || '-'}äºº
            </div>
            <div>
              <strong>ç”³è«‹è€…ä»£è¡¨:</strong> ${reservation.applicantRepresentative || '-'}
            </div>
            <div>
              <strong>é›»è©±ç•ªå·:</strong> ${reservation.applicantPhone || '-'}
            </div>
            <div style="grid-column: 1 / -1;">
              <strong>ãƒ¡ãƒ¼ãƒ«:</strong> ${reservation.applicantEmail || '-'}
            </div>
          </div>
        </div>

        <!-- å…¥å ´æ–™æƒ…å ± -->
        <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
          <h3 style="margin-bottom: 1rem; color: #2c3e50;">å…¥å ´æ–™æƒ…å ±</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div>
              <strong>å…¥å ´æ–™åŒºåˆ†:</strong> ${reservation.entranceFeeType === 'free' ? 'ç„¡æ–™' : 'æœ‰æ–™'}
            </div>
            ${reservation.entranceFeeType === 'paid' ? `
              <div>
                <strong>å…¥å ´æ–™é‡‘é¡:</strong> Â¥${(reservation.entranceFeeAmount || 0).toLocaleString()}
              </div>
              <div>
                <strong>æ–™é‡‘ä¹—æ•°:</strong> ${reservation.ticketMultiplier || 1}
              </div>
            ` : ''}
          </div>
        </div>

        <!-- åˆ©ç”¨æ–½è¨­ãƒ»æ—¥ç¨‹ -->
        <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
          <h3 style="margin-bottom: 1rem; color: #2c3e50;">åˆ©ç”¨æ–½è¨­ãƒ»æ—¥ç¨‹</h3>
          ${usages.length > 0 ? `
            <table class="table" style="margin-top: 1rem;">
              <thead>
                <tr>
                  <th>æ—¥ä»˜</th>
                  <th>æ–½è¨­</th>
                  <th>æ™‚é–“å¸¯</th>
                  <th>ç©ºèª¿</th>
                  <th>é‡‘é¡</th>
                </tr>
              </thead>
              <tbody>
                ${usages.map(usage => {
                  const slots = [];
                  if (usage.useMorning) slots.push('åˆå‰');
                  if (usage.useMiddayExtension) slots.push('æ­£åˆå»¶é•·');
                  if (usage.useAfternoon) slots.push('åˆå¾Œ');
                  if (usage.useEveningExtension) slots.push('å¤•æ–¹å»¶é•·');
                  if (usage.useEvening) slots.push('å¤œé–“');

                  return `
                    <tr>
                      <td>${new Date(usage.date).toLocaleDateString('ja-JP')}</td>
                      <td>${usage.roomName || '-'}</td>
                      <td>${slots.join(', ')}</td>
                      <td>${usage.acRequested ? (usage.acHours ? usage.acHours + 'æ™‚é–“' : 'è¦') : '-'}</td>
                      <td>Â¥${(usage.subtotalAmount || 0).toLocaleString()}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          ` : '<p style="color: #7f8c8d;">åˆ©ç”¨æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>'}
        </div>

        <!-- æ–™é‡‘æƒ…å ± -->
        <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
          <h3 style="margin-bottom: 1rem; color: #2c3e50;">æ–™é‡‘æƒ…å ±</h3>
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: #3498db; color: white; border-radius: 4px;">
            <span style="font-size: 1.25rem; font-weight: 600;">åˆè¨ˆé‡‘é¡</span>
            <span style="font-size: 1.75rem; font-weight: 700;">Â¥${(reservation.totalAmount || 0).toLocaleString()}</span>
          </div>
          <div style="margin-top: 1rem; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div>
              <strong>æ±ºæ¸ˆçŠ¶æ³:</strong>
              <span class="badge badge-${reservation.paymentStatus === 'paid' ? 'success' : reservation.paymentStatus === 'unpaid' ? 'warning' : 'info'}" style="margin-left: 0.5rem;">
                ${reservation.paymentStatus === 'paid' ? 'æ”¯æ‰•æ¸ˆ' : reservation.paymentStatus === 'unpaid' ? 'æœªæ±ºæ¸ˆ' : 'è¿”é‡‘æ¸ˆ'}
              </span>
            </div>
            <div>
              <strong>ã‚­ãƒ£ãƒ³ã‚»ãƒ«:</strong>
              <span class="badge badge-${reservation.cancelStatus === 'cancelled' ? 'danger' : 'success'}" style="margin-left: 0.5rem;">
                ${reservation.cancelStatus === 'cancelled' ? 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆ' : 'æœ‰åŠ¹'}
              </span>
            </div>
            ${reservation.cancelStatus === 'cancelled' ? `
              <div>
                <strong>ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ—¥:</strong> ${reservation.cancelledAt ? new Date(reservation.cancelledAt).toLocaleDateString('ja-JP') : '-'}
              </div>
              <div>
                <strong>ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™:</strong> Â¥${(reservation.cancellationFee || 0).toLocaleString()}
              </div>
            ` : ''}
          </div>
        </div>

        <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
        <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #ecf0f1;">
          <button onclick="showNotes(${id})" class="btn btn-primary">ãƒ¡ãƒ¢ã‚’è¦‹ã‚‹</button>
          ${canUpdatePayment && reservation.paymentStatus === 'unpaid' ? `
            <button onclick="updatePaymentStatus(${id}, 'paid')" class="btn btn-success">æ”¯æ‰•æ¸ˆã«ã™ã‚‹</button>
          ` : ''}
          ${canUpdatePayment && reservation.paymentStatus === 'paid' ? `
            <button onclick="updatePaymentStatus(${id}, 'refunded')" class="btn" style="background-color: #9b59b6; color: white;">è¿”é‡‘æ¸ˆã«ã™ã‚‹</button>
          ` : ''}
          ${canCancel ? `
            <button onclick="cancelReservation(${id})" class="btn btn-danger">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          ` : ''}
        </div>
      </div>
    `;

    document.getElementById('detailContent').innerHTML = html;
    document.getElementById('detailModal').style.display = 'block';
  } catch (error) {
    console.error('Error loading reservation detail:', error);
    alert('è©³ç´°æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeDetailModal() {
  document.getElementById('detailModal').style.display = 'none';
  currentReservationId = null;
}

// æ±ºæ¸ˆçŠ¶æ³ã‚’æ›´æ–°
async function updatePaymentStatus(id, status) {
  if (!confirm(`æ±ºæ¸ˆçŠ¶æ³ã‚’ã€Œ${status === 'paid' ? 'æ”¯æ‰•æ¸ˆ' : 'è¿”é‡‘æ¸ˆ'}ã€ã«æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ`)) {
    return;
  }

  try {
    const res = await fetch(`/api/staff/reservations/${id}/payment-status`, {
      method: 'PATCH',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ paymentStatus: status })
    });

    if (res.ok) {
      alert('æ±ºæ¸ˆçŠ¶æ³ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      closeDetailModal();
      loadReservations();
    } else {
      const error = await res.json();
      alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }
  } catch (error) {
    console.error('Error updating payment status:', error);
    alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
async function cancelReservation(id) {
  const reason = prompt('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰:');
  if (reason === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«

  try {
    const res = await fetch(`/api/staff/reservations/${id}/cancel`, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ reason })
    });

    if (res.ok) {
      alert('äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
      closeDetailModal();
      loadReservations();
    } else {
      const error = await res.json();
      alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }
  } catch (error) {
    console.error('Error cancelling reservation:', error);
    alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ãƒ¡ãƒ¢ã‚’è¡¨ç¤º
async function showNotes(id) {
  try {
    const res = await fetch(`/api/staff/reservations/${id}/notes`, {
      credentials: 'include',
      });
    const notes = await res.json();

    const html = `
      <div style="margin-bottom: 1.5rem;">
        <h3 style="margin-bottom: 1rem;">ãƒ¡ãƒ¢ä¸€è¦§</h3>
        <div id="notesList" style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
          ${notes.length > 0 ? notes.map(note => `
            <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px; margin-bottom: 0.5rem;">
              <div style="font-size: 0.875rem; color: #7f8c8d; margin-bottom: 0.5rem;">
                ${new Date(note.createdAt).toLocaleString('ja-JP')} - ${note.staffName || 'è·å“¡'}
              </div>
              <div>${note.content}</div>
            </div>
          `).join('') : '<p style="text-align: center; color: #7f8c8d;">ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“</p>'}
        </div>
      </div>

      <div style="border-top: 1px solid #ecf0f1; padding-top: 1rem;">
        <h3 style="margin-bottom: 1rem;">ãƒ¡ãƒ¢ã‚’è¿½åŠ </h3>
        <textarea id="newNoteContent" rows="4" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..." style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
        <div style="display: flex; gap: 1rem; margin-top: 1rem; justify-content: flex-end;">
          <button onclick="closeNoteModal()" class="btn" style="background-color: #95a5a6; color: white;">é–‰ã˜ã‚‹</button>
          <button onclick="addNote(${id})" class="btn btn-primary">ãƒ¡ãƒ¢ã‚’è¿½åŠ </button>
        </div>
      </div>
    `;

    document.getElementById('noteContent').innerHTML = html;
    document.getElementById('noteModal').style.display = 'block';
  } catch (error) {
    console.error('Error loading notes:', error);
    alert('ãƒ¡ãƒ¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeNoteModal() {
  document.getElementById('noteModal').style.display = 'none';
}

// ãƒ¡ãƒ¢ã‚’è¿½åŠ 
async function addNote(id) {
  const content = document.getElementById('newNoteContent').value.trim();
  if (!content) {
    alert('ãƒ¡ãƒ¢å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  try {
    const res = await fetch(`/api/staff/reservations/${id}/notes`, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ content })
    });

    if (res.ok) {
      alert('ãƒ¡ãƒ¢ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      closeNoteModal();
    } else {
      const error = await res.json();
      alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }
  } catch (error) {
    console.error('Error adding note:', error);
    alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('detailModal').addEventListener('click', (e) => {
  if (e.target.id === 'detailModal') {
    closeDetailModal();
  }
});

document.getElementById('noteModal').addEventListener('click', (e) => {
  if (e.target.id === 'noteModal') {
    closeNoteModal();
  }
});

// CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
function exportToCSV() {
  if (!currentReservations || currentReservations.length === 0) {
    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  // CSVãƒ˜ãƒƒãƒ€ãƒ¼
  const headers = ['ID', 'ã‚¤ãƒ™ãƒ³ãƒˆå', 'ç”³è«‹è€…', 'åˆ©ç”¨æ—¥', 'æ–½è¨­', 'é‡‘é¡', 'æ±ºæ¸ˆçŠ¶æ³', 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'];

  // CSVãƒ‡ãƒ¼ã‚¿è¡Œ
  const rows = currentReservations.map(res => {
    const usageDates = res.usageDates ? res.usageDates.join(' / ') : '-';
    const rooms = res.rooms ? res.rooms.join(' / ') : '-';
    const paymentStatus = res.paymentStatus === 'paid' ? 'æ”¯æ‰•æ¸ˆ' : res.paymentStatus === 'unpaid' ? 'æœªæ±ºæ¸ˆ' : 'è¿”é‡‘æ¸ˆ';
    const cancelStatus = res.cancelStatus === 'cancelled' ? 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆ' : 'æœ‰åŠ¹';

    return [
      res.id,
      res.eventName || '-',
      res.applicantName || '-',
      usageDates,
      rooms,
      res.totalAmount || 0,
      paymentStatus,
      cancelStatus
    ];
  });

  // CSVå½¢å¼ã«å¤‰æ›
  const csvContent = [
    headers.join(','),
    ...rows.map(row => row.map(cell => {
      // ã‚»ãƒ«å†…ã«ã‚«ãƒ³ãƒã‚„æ”¹è¡ŒãŒã‚ã‚‹å ´åˆã¯ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€
      const cellStr = String(cell);
      if (cellStr.includes(',') || cellStr.includes('\n') || cellStr.includes('"')) {
        return '"' + cellStr.replace(/"/g, '""') + '"';
      }
      return cellStr;
    }).join(','))
  ].join('\n');

  // BOMä»˜ãUTF-8ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆExcelã§æ–‡å­—åŒ–ã‘ã—ãªã„ã‚ˆã†ã«ï¼‰
  const bom = '\uFEFF';
  const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });

  // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ã‚¯ãƒªãƒƒã‚¯
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  const now = new Date();
  const filename = `reservations_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}.csv`;

  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>
