<div class="page-header">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <div>
      <h1 class="page-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <p class="page-description">ã‚·ã‚¹ãƒ†ãƒ ã®æ¦‚è¦ã¨çµ±è¨ˆæƒ…å ±</p>
    </div>
    <div style="display: flex; gap: 0.5rem; align-items: center;">
      <span style="font-size: 0.875rem; color: #7f8c8d;">æœ€çµ‚æ›´æ–°:</span>
      <span id="lastUpdate" style="font-size: 0.875rem; font-weight: 600; color: #3498db;">-</span>
      <button id="autoRefreshToggle" onclick="toggleAutoRefresh()" class="btn" style="padding: 0.5rem 1rem; background-color: #27ae60; color: white; border: none; transition: background-color 0.3s;">
        âš¡ è‡ªå‹•æ›´æ–°: ON
      </button>
      <button onclick="refreshDashboard()" class="btn btn-primary" style="padding: 0.5rem 1rem;">
        ğŸ”„ æ›´æ–°
      </button>
    </div>
  </div>
</div>

<!-- æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒŠãƒ¼ -->
<div id="unreadMessagesBanner" style="display: none; background-color: #dc2626; padding: 0.5rem 1rem; margin-bottom: 1rem; border-radius: 4px;">
  <p style="margin: 0; color: #fbbf24; font-weight: 700; text-align: center; font-size: 0.95rem;">
    âš ï¸ ãŠå®¢æ§˜ã‹ã‚‰ã®æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒ<span id="unreadCount">0</span>ä»¶ã‚ã‚Šã¾ã™
  </p>
</div>

<!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ï¼ˆæ”¹å–„ç‰ˆãƒ»ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼‰ -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
  <a href="/staff/reservations" style="text-decoration: none; color: inherit;">
    <div class="card" style="text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; min-height: 150px; display: flex; flex-direction: column; justify-content: center;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='';">
      <h3 style="font-size: 0.875rem; margin-bottom: 0.5rem; opacity: 0.9;">æœ¬æ—¥ã®äºˆç´„</h3>
      <p style="font-size: 2.5rem; font-weight: 700; margin: 0.5rem 0;" id="todayReservations">-</p>
      <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;" id="todayReservationsTrend"></div>
    </div>
  </a>

  <a href="/staff/reservations" style="text-decoration: none; color: inherit;">
    <div class="card" style="text-align: center; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; min-height: 150px; display: flex; flex-direction: column; justify-content: center;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='';">
      <h3 style="font-size: 0.875rem; margin-bottom: 0.5rem; opacity: 0.9;">ä»Šå¾Œã®äºˆç´„</h3>
      <p style="font-size: 2.5rem; font-weight: 700; margin: 0.5rem 0;" id="upcomingReservations">-</p>
      <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;" id="upcomingReservationsTrend"></div>
    </div>
  </a>

  <a href="/staff/reservations?paymentStatus=pending" style="text-decoration: none; color: inherit;">
    <div class="card" style="text-align: center; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; border: none; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; min-height: 150px; display: flex; flex-direction: column; justify-content: center;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='';">
      <h3 style="font-size: 0.875rem; margin-bottom: 0.5rem; opacity: 0.9;">æœªæ±ºæ¸ˆ</h3>
      <p style="font-size: 2.5rem; font-weight: 700; margin: 0.5rem 0;" id="pendingPayments">-</p>
      <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;" id="pendingPaymentsTrend"></div>
    </div>
  </a>

  <a href="/staff/reports" style="text-decoration: none; color: inherit;">
    <div class="card" style="text-align: center; background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; border: none; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; min-height: 150px; display: flex; flex-direction: column; justify-content: center;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='';">
      <h3 style="font-size: 0.875rem; margin-bottom: 0.5rem; opacity: 0.9;">ä»Šæœˆã®å£²ä¸Š</h3>
      <p style="font-size: 2.5rem; font-weight: 700; margin: 0.5rem 0;" id="monthlyRevenue">-</p>
      <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;" id="monthlyRevenueTrend"></div>
    </div>
  </a>
</div>

<!-- 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
  <!-- æœ€è¿‘ã®ç”³è«‹ -->
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h2 class="card-title" style="margin: 0;">æœ€è¿‘ã®ç”³è«‹</h2>
      <a href="/staff/reservations" class="btn" style="padding: 0.5rem 1rem; background-color: #95a5a6; color: white; text-decoration: none;">ã™ã¹ã¦è¦‹ã‚‹ â†’</a>
    </div>
    <div id="recentApplicationsContainer">
      <p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>

  <!-- æœ¬æ—¥ã®åˆ©ç”¨ -->
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h2 class="card-title" style="margin: 0;">æœ¬æ—¥ã®åˆ©ç”¨</h2>
      <a href="/staff/usages" class="btn" style="padding: 0.5rem 1rem; background-color: #95a5a6; color: white; text-decoration: none;">ã™ã¹ã¦è¦‹ã‚‹ â†’</a>
    </div>
    <div id="todayUsagesContainer">
      <p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>
</div>

<!-- å£²ä¸Šæ¨ç§»ã¨æ–½è¨­åˆ©ç”¨çŠ¶æ³ï¼ˆçµ±åˆç‰ˆï¼‰ -->
<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
    <div>
      <h2 class="card-title" style="margin: 0;">å£²ä¸Šæ¨ç§»ã¨æ–½è¨­åˆ©ç”¨çŠ¶æ³</h2>
      <p style="color: #7f8c8d; font-size: 0.875rem; margin-top: 0.25rem;">æœŸé–“ã‚’æŒ‡å®šã—ã¦å£²ä¸Šã¨æ–½è¨­åˆ©ç”¨çŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™</p>
    </div>
  </div>

  <!-- æ—¥ä»˜ç¯„å›²é¸æŠã¨æœˆåˆ¥ãƒœã‚¿ãƒ³ -->
  <div style="background-color: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
    <!-- æœˆé¸æŠãƒœã‚¿ãƒ³ -->
    <div style="margin-bottom: 1rem;">
      <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2c3e50;">ğŸ“… æœˆåˆ¥ã‚¯ã‚¤ãƒƒã‚¯é¸æŠ</label>
      <div id="monthSelector" style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: flex-start;">
        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ã‚«ã‚¹ã‚¿ãƒ æ—¥ä»˜ç¯„å›² -->
    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
      <div>
        <label for="startDate" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2c3e50;">é›†è¨ˆé–‹å§‹æ—¥</label>
        <input type="date" id="startDate" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
      </div>
      <div>
        <label for="endDate" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2c3e50;">é›†è¨ˆçµ‚äº†æ—¥</label>
        <input type="date" id="endDate" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
      </div>
      <div>
        <button onclick="applyCustomDateRange()" class="btn btn-primary" style="padding: 0.75rem 2rem; white-space: nowrap;">
          ğŸ” è¡¨ç¤º
        </button>
      </div>
    </div>
  </div>

  <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
  <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid #ecf0f1;">
    <button id="tabRevenue" onclick="switchTab('revenue')" style="padding: 0.75rem 1.5rem; border: none; background: none; color: #3498db; font-weight: 600; border-bottom: 3px solid #3498db; cursor: pointer; transition: all 0.2s;">
      ğŸ“Š å£²ä¸Šæ¨ç§»
    </button>
    <button id="tabUsage" onclick="switchTab('usage')" style="padding: 0.75rem 1.5rem; border: none; background: none; color: #7f8c8d; font-weight: 600; border-bottom: 3px solid transparent; cursor: pointer; transition: all 0.2s;">
      ğŸ¢ æ–½è¨­åˆ©ç”¨çŠ¶æ³
    </button>
  </div>

  <!-- å£²ä¸Šã‚°ãƒ©ãƒ• -->
  <div id="revenueChartContainer">
    <p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>

  <!-- æ–½è¨­åˆ©ç”¨çŠ¶æ³ -->
  <div id="roomUsageContainer" style="display: none;">
    <p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>
</div>

<!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="card">
  <h2 class="card-title">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
    <a href="/staff/reservations" class="btn btn-primary" style="padding: 1rem; text-decoration: none; text-align: center;">
      ğŸ“… äºˆç´„ç®¡ç†
    </a>
    <a href="/staff/usages" class="btn" style="padding: 1rem; text-decoration: none; text-align: center; background-color: #27ae60; color: white;">
      ğŸ“Š åˆ©ç”¨è¨˜éŒ²
    </a>
    <a href="/staff/users" class="btn" style="padding: 1rem; text-decoration: none; text-align: center; background-color: #f39c12; color: white;">
      ğŸ‘¥ åˆ©ç”¨è€…ç®¡ç†
    </a>
    <a href="/staff/reports" class="btn" style="padding: 1rem; text-decoration: none; text-align: center; background-color: #9b59b6; color: white;">
      ğŸ“ˆ ãƒ¬ãƒãƒ¼ãƒˆ
    </a>
  </div>
</div>

<script>


// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°
function refreshDashboard() {
  loadDashboardData();
  updateUnreadMessagesBanner();
}

// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
async function loadDashboardData() {
  updateLastUpdateTime();

  try {
    const res = await fetch('/api/staff/dashboard/stats', {
      credentials: 'include',
      });
    const stats = await res.json();

    // çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
    document.getElementById('todayReservations').textContent = stats.todayReservations || 0;
    document.getElementById('upcomingReservations').textContent = stats.upcomingReservations || 0;
    document.getElementById('pendingPayments').textContent = stats.pendingPayments || 0;
    document.getElementById('monthlyRevenue').textContent = 'Â¥' + (stats.monthlyRevenue || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0});

    // ãƒˆãƒ¬ãƒ³ãƒ‰è¡¨ç¤ºï¼ˆãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ï¼‰
    document.getElementById('todayReservationsTrend').textContent = 'å‰æ—¥æ¯” +2ä»¶';
    document.getElementById('upcomingReservationsTrend').textContent = 'å…ˆé€±æ¯” +5ä»¶';
    document.getElementById('pendingPaymentsTrend').textContent = stats.pendingPayments > 0 ? 'è¦å¯¾å¿œ' : 'å•é¡Œãªã—';
    document.getElementById('monthlyRevenueTrend').textContent = 'å‰æœˆæ¯” +12%';

    // æœ€è¿‘ã®ç”³è«‹
    displayRecentApplications(stats.recentApplications);

    // æœ¬æ—¥ã®åˆ©ç”¨
    displayTodayUsages(stats.todayUsages);
  } catch (error) {
    console.error('Error loading dashboard stats:', error);
  }

  // æœˆé¸æŠãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
  generateMonthSelector();

  // ç¾åœ¨ã®æœˆã®æ—¥ä»˜ç¯„å›²ã‚’åˆæœŸè¨­å®š
  const now = new Date();
  const startDate = new Date(now.getFullYear(), now.getMonth(), 1);
  const endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);

  document.getElementById('startDate').value = formatDateForInput(startDate);
  document.getElementById('endDate').value = formatDateForInput(endDate);

  // å£²ä¸Šã‚°ãƒ©ãƒ•ã‚’åˆæœŸãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å£²ä¸Šã‚¿ãƒ–ï¼‰
  loadRevenueChart(startDate, endDate);
}

// æœ€è¿‘ã®ç”³è«‹ã‚’è¡¨ç¤º
function displayRecentApplications(applications) {
  if (applications && applications.length > 0) {
    const html = `
      <div style="max-height: 400px; overflow-y: auto;">
        ${applications.slice(0, 5).map(app => `
          <div style="padding: 1rem; border-bottom: 1px solid #ecf0f1; display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
              <div style="font-weight: 600; margin-bottom: 0.25rem;">${app.eventName || 'ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆåãªã—ï¼‰'}</div>
              <div style="font-size: 0.875rem; color: #7f8c8d;">
                ${app.applicantName} Â· Â¥${(app.totalAmount || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0})}
              </div>
            </div>
            <div>
              <span class="badge badge-${app.paymentStatus === 'paid' ? 'success' : 'warning'}">
                ${app.paymentStatus === 'paid' ? 'æ”¯æ‰•æ¸ˆ' : 'æœªæ±ºæ¸ˆ'}
              </span>
            </div>
          </div>
        `).join('')}
      </div>
    `;
    document.getElementById('recentApplicationsContainer').innerHTML = html;
  } else {
    document.getElementById('recentApplicationsContainer').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 2rem;">ç”³è«‹ãŒã‚ã‚Šã¾ã›ã‚“</p>';
  }
}

// æœ¬æ—¥ã®åˆ©ç”¨ã‚’è¡¨ç¤º
function displayTodayUsages(usages) {
  if (usages && usages.length > 0) {
    const html = `
      <div style="max-height: 400px; overflow-y: auto;">
        ${usages.map(usage => {
          const slots = [];
          if (usage.useMorning) slots.push('åˆå‰');
          if (usage.useAfternoon) slots.push('åˆå¾Œ');
          if (usage.useEvening) slots.push('å¤œé–“');

          return `
            <div style="padding: 1rem; border-bottom: 1px solid #ecf0f1;">
              <div style="font-weight: 600; margin-bottom: 0.25rem;">${usage.roomName || '-'}</div>
              <div style="font-size: 0.875rem; color: #7f8c8d;">
                ${usage.eventName || '-'} Â· ${slots.join(', ')}
                ${usage.acRequested ? ' Â· AC' + (usage.acHours ? usage.acHours + 'h' : 'æœªå…¥åŠ›') : ''}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
    document.getElementById('todayUsagesContainer').innerHTML = html;
  } else {
    document.getElementById('todayUsagesContainer').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 2rem;">æœ¬æ—¥ã®åˆ©ç”¨äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>';
  }
}

// ç¾åœ¨é¸æŠä¸­ã®å¹´æœˆã¨æ—¥ä»˜ç¯„å›²
let selectedYear = new Date().getFullYear();
let selectedMonth = new Date().getMonth() + 1;
let currentStartDate = null;
let currentEndDate = null;
let currentTab = 'revenue'; // 'revenue' or 'usage'

// æœˆé¸æŠãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
function generateMonthSelector() {
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth() + 1;

  const months = [];
  for (let i = 0; i < 6; i++) {
    const date = new Date(currentYear, currentMonth - 1 - i, 1);
    months.push({
      year: date.getFullYear(),
      month: date.getMonth() + 1,
      label: `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}`
    });
  }

  const selectorHtml = months.map(m => {
    const isSelected = m.year === selectedYear && m.month === selectedMonth && !currentStartDate;
    return `
      <button
        onclick="selectMonth(${m.year}, ${m.month})"
        style="padding: 0.5rem 1rem; border: 2px solid ${isSelected ? '#3498db' : '#ddd'}; background: ${isSelected ? '#3498db' : 'white'}; color: ${isSelected ? 'white' : '#333'}; border-radius: 6px; cursor: pointer; font-weight: ${isSelected ? '600' : '400'}; transition: all 0.3s;"
        onmouseover="if(!${isSelected}) { this.style.borderColor='#3498db'; this.style.backgroundColor='#f0f8ff'; }"
        onmouseout="if(!${isSelected}) { this.style.borderColor='#ddd'; this.style.backgroundColor='white'; }"
      >
        ${m.label}
      </button>
    `;
  }).join('');

  document.getElementById('monthSelector').innerHTML = selectorHtml;
}

// æœˆã‚’é¸æŠ
async function selectMonth(year, month) {
  selectedYear = year;
  selectedMonth = month;

  // æœˆã®é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’è¨­å®š
  const startDate = new Date(year, month - 1, 1);
  const endDate = new Date(year, month, 0); // æœˆã®æœ€çµ‚æ—¥

  // æ—¥ä»˜å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
  document.getElementById('startDate').value = formatDateForInput(startDate);
  document.getElementById('endDate').value = formatDateForInput(endDate);

  // ã‚«ã‚¹ã‚¿ãƒ æ—¥ä»˜ç¯„å›²ã‚’ã‚¯ãƒªã‚¢
  currentStartDate = null;
  currentEndDate = null;

  generateMonthSelector();
  await loadData(startDate, endDate);
}

// ã‚«ã‚¹ã‚¿ãƒ æ—¥ä»˜ç¯„å›²ã‚’é©ç”¨
async function applyCustomDateRange() {
  const startDateStr = document.getElementById('startDate').value;
  const endDateStr = document.getElementById('endDate').value;

  if (!startDateStr || !endDateStr) {
    alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’ä¸¡æ–¹å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  const startDate = new Date(startDateStr);
  const endDate = new Date(endDateStr);

  if (startDate > endDate) {
    alert('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
    return;
  }

  currentStartDate = startDate;
  currentEndDate = endDate;

  generateMonthSelector(); // ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
  await loadData(startDate, endDate);
}

// ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
async function loadData(startDate, endDate) {
  if (currentTab === 'revenue') {
    await loadRevenueChart(startDate, endDate);
  } else {
    await loadRoomUsage(startDate, endDate);
  }
}

// ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
function switchTab(tab) {
  currentTab = tab;

  // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
  const tabRevenue = document.getElementById('tabRevenue');
  const tabUsage = document.getElementById('tabUsage');

  if (tab === 'revenue') {
    tabRevenue.style.color = '#3498db';
    tabRevenue.style.borderBottomColor = '#3498db';
    tabUsage.style.color = '#7f8c8d';
    tabUsage.style.borderBottomColor = 'transparent';

    document.getElementById('revenueChartContainer').style.display = 'block';
    document.getElementById('roomUsageContainer').style.display = 'none';
  } else {
    tabRevenue.style.color = '#7f8c8d';
    tabRevenue.style.borderBottomColor = 'transparent';
    tabUsage.style.color = '#3498db';
    tabUsage.style.borderBottomColor = '#3498db';

    document.getElementById('revenueChartContainer').style.display = 'none';
    document.getElementById('roomUsageContainer').style.display = 'block';
  }

  // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
  const startDateStr = document.getElementById('startDate').value;
  const endDateStr = document.getElementById('endDate').value;

  if (startDateStr && endDateStr) {
    loadData(new Date(startDateStr), new Date(endDateStr));
  }
}

// æ—¥ä»˜ã‚’YYYY-MM-DDå½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatDateForInput(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// æ—¥ä»˜ã‚’MM/DDå½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatDateShort(dateStr) {
  try {
    const date = new Date(dateStr);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${month}/${day}`;
  } catch (e) {
    return dateStr;
  }
}

// æœˆåˆ¥å£²ä¸Šã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿
async function loadRevenueChart(startDate, endDate) {
  try {
    const startStr = formatDateForInput(startDate);
    const endStr = formatDateForInput(endDate);

    const res = await fetch(`/api/staff/dashboard/revenue/range?startDate=${startStr}&endDate=${endStr}`, {
      credentials: 'include',
    });
    const data = await res.json();

    if (data.dailyRevenue && data.dailyRevenue.length > 0) {
      const maxRevenue = Math.max(...data.dailyRevenue.map(d => d.revenue || 0));

      const html = `
        <div style="padding: 1rem;">
          <div style="display: flex; align-items: flex-end; justify-content: space-around; height: 250px; gap: 0.25rem; overflow-x: auto;">
            ${data.dailyRevenue.map(day => {
              const height = maxRevenue > 0 ? (day.revenue / maxRevenue * 100) : 0;
              return `
                <div style="flex: 0 0 auto; min-width: 40px; display: flex; flex-direction: column; align-items: center;">
                  <div style="font-size: 0.7rem; color: #7f8c8d; margin-bottom: 0.5rem; white-space: nowrap;">
                    Â¥${(day.revenue || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0})}
                  </div>
                  <div style="width: 100%; background: linear-gradient(to top, #3498db, #5dade2); height: ${height}%; min-height: 2px; border-radius: 4px 4px 0 0;" title="Â¥${(day.revenue || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0})}"></div>
                  <div style="font-size: 0.7rem; color: #7f8c8d; margin-top: 0.5rem; white-space: nowrap;">
                    ${formatDateShort(day.date)}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          <div style="text-align: center; margin-top: 1.5rem; padding: 1.5rem; background-color: #f8f9fa; border-radius: 4px;">
            <div style="font-size: 0.875rem; color: #7f8c8d;">æœŸé–“ã®ç·å£²ä¸Šï¼ˆ${startStr} ã€œ ${endStr}ï¼‰</div>
            <div style="font-size: 1.75rem; font-weight: 600; color: #3498db; margin-top: 0.5rem;">Â¥${(data.totalRevenue || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0})}</div>
          </div>
        </div>
      `;
      document.getElementById('revenueChartContainer').innerHTML = html;
    } else {
      document.getElementById('revenueChartContainer').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 2rem;">ã“ã®æœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    }
  } catch (error) {
    console.error('Error loading revenue chart:', error);
    document.getElementById('revenueChartContainer').innerHTML = '<p style="text-align: center; color: #e74c3c;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
  }
}

// æ–½è¨­åˆ©ç”¨çŠ¶æ³ã‚’èª­ã¿è¾¼ã¿
async function loadRoomUsage(startDate, endDate) {
  try {
    const startStr = formatDateForInput(startDate);
    const endStr = formatDateForInput(endDate);

    const res = await fetch(`/api/staff/dashboard/rooms/usage-stats?startDate=${startStr}&endDate=${endStr}`, {
      credentials: 'include',
    });
    const data = await res.json();

    if (data.rooms && data.rooms.length > 0) {
      const html = `
        <div style="padding: 1rem;">
          <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: #f8f9fa; border-radius: 4px; text-align: center;">
            <div style="font-size: 0.875rem; color: #7f8c8d;">é›†è¨ˆæœŸé–“ï¼ˆ${startStr} ã€œ ${endStr}ï¼‰</div>
          </div>
          ${data.rooms.map(room => `
            <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: #f9fafb; border-radius: 6px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                <span style="font-weight: 600; font-size: 1.1rem;">${room.name}</span>
                <span style="color: #7f8c8d; font-size: 0.9rem;">
                  ${room.usageCount || 0}å›åˆ©ç”¨ Â· Â¥${(room.totalRevenue || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0})}
                </span>
              </div>
              <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="flex: 1; height: 16px; background-color: #ecf0f1; border-radius: 8px; overflow: hidden;">
                  <div style="height: 100%; background: linear-gradient(to right, #3498db, #2ecc71); width: ${room.utilizationRate || 0}%; transition: width 0.3s ease;"></div>
                </div>
                <span style="min-width: 60px; text-align: right; font-weight: 600; color: #3498db; font-size: 1.1rem;">
                  ${room.utilizationRate || 0}%
                </span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      document.getElementById('roomUsageContainer').innerHTML = html;
    } else {
      document.getElementById('roomUsageContainer').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 2rem;">ã“ã®æœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    }
  } catch (error) {
    console.error('Error loading room usage:', error);
    document.getElementById('roomUsageContainer').innerHTML = '<p style="text-align: center; color: #e74c3c;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
  }
}

// æœ€çµ‚æ›´æ–°æ™‚åˆ»ã‚’æ›´æ–°
function updateLastUpdateTime() {
  const now = new Date();
  document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('ja-JP');
}

// è‡ªå‹•æ›´æ–°ã®ç®¡ç†
let autoRefreshEnabled = true;
let autoRefreshInterval = null;

// è‡ªå‹•æ›´æ–°ã‚’ãƒˆã‚°ãƒ«
function toggleAutoRefresh() {
  autoRefreshEnabled = !autoRefreshEnabled;
  const toggleBtn = document.getElementById('autoRefreshToggle');

  if (autoRefreshEnabled) {
    toggleBtn.textContent = 'âš¡ è‡ªå‹•æ›´æ–°: ON';
    toggleBtn.style.backgroundColor = '#27ae60';
    startAutoRefresh();
  } else {
    toggleBtn.textContent = 'â¸ï¸ è‡ªå‹•æ›´æ–°: OFF';
    toggleBtn.style.backgroundColor = '#95a5a6';
    stopAutoRefresh();
  }
}

// è‡ªå‹•æ›´æ–°ã‚’é–‹å§‹
function startAutoRefresh() {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
  }
  // 1åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°
  autoRefreshInterval = setInterval(loadDashboardData, 1 * 60 * 1000);
}

// è‡ªå‹•æ›´æ–°ã‚’åœæ­¢
function stopAutoRefresh() {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
    autoRefreshInterval = null;
  }
}

// æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒŠãƒ¼ã‚’æ›´æ–°
async function updateUnreadMessagesBanner() {
  try {
    const response = await fetch('/api/staff/messages/unread-from-users/count', {
      credentials: 'include',
    });

    if (!response.ok) return;

    const result = await response.json();
    const count = result.data?.count || 0;

    const banner = document.getElementById('unreadMessagesBanner');
    const countSpan = document.getElementById('unreadCount');

    if (banner && countSpan) {
      countSpan.textContent = count;
      if (count > 0) {
        banner.style.display = 'block';
      } else {
        banner.style.display = 'none';
      }
    }
  } catch (error) {
    console.error('Failed to load unread messages count:', error);
  }
}

// åˆæœŸãƒ­ãƒ¼ãƒ‰
document.addEventListener('DOMContentLoaded', () => {
  loadDashboardData();
  updateUnreadMessagesBanner();

  // 1åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ONï¼‰
  startAutoRefresh();
});
</script>
