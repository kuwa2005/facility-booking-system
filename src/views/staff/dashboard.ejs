<div class="page-header">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <div>
      <h1 class="page-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <p class="page-description">ã‚·ã‚¹ãƒ†ãƒ ã®æ¦‚è¦ã¨çµ±è¨ˆæƒ…å ±</p>
    </div>
    <div style="display: flex; gap: 0.5rem; align-items: center;">
      <span style="font-size: 0.875rem; color: #7f8c8d;">æœ€çµ‚æ›´æ–°:</span>
      <span id="lastUpdate" style="font-size: 0.875rem; font-weight: 600; color: #3498db;">-</span>
      <button onclick="refreshDashboard()" class="btn btn-primary" style="padding: 0.5rem 1rem;">
        ğŸ”„ æ›´æ–°
      </button>
    </div>
  </div>
</div>

<!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ï¼ˆæ”¹å–„ç‰ˆãƒ»ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼‰ -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
  <a href="/staff/reservations" style="text-decoration: none; color: inherit;">
    <div class="card" style="text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; min-height: 150px; display: flex; flex-direction: column; justify-content: center;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='';">
      <h3 style="font-size: 0.875rem; margin-bottom: 0.5rem; opacity: 0.9;">æœ¬æ—¥ã®äºˆç´„</h3>
      <p style="font-size: 2.5rem; font-weight: 700; margin: 0.5rem 0;" id="todayReservations">-</p>
      <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;" id="todayReservationsTrend"></div>
    </div>
  </a>

  <a href="/staff/reservations" style="text-decoration: none; color: inherit;">
    <div class="card" style="text-align: center; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; min-height: 150px; display: flex; flex-direction: column; justify-content: center;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='';">
      <h3 style="font-size: 0.875rem; margin-bottom: 0.5rem; opacity: 0.9;">ä»Šå¾Œã®äºˆç´„</h3>
      <p style="font-size: 2.5rem; font-weight: 700; margin: 0.5rem 0;" id="upcomingReservations">-</p>
      <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;" id="upcomingReservationsTrend"></div>
    </div>
  </a>

  <a href="/staff/reservations?paymentStatus=pending" style="text-decoration: none; color: inherit;">
    <div class="card" style="text-align: center; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; border: none; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; min-height: 150px; display: flex; flex-direction: column; justify-content: center;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='';">
      <h3 style="font-size: 0.875rem; margin-bottom: 0.5rem; opacity: 0.9;">æœªæ±ºæ¸ˆ</h3>
      <p style="font-size: 2.5rem; font-weight: 700; margin: 0.5rem 0;" id="pendingPayments">-</p>
      <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;" id="pendingPaymentsTrend"></div>
    </div>
  </a>

  <a href="/staff/reports" style="text-decoration: none; color: inherit;">
    <div class="card" style="text-align: center; background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; border: none; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; min-height: 150px; display: flex; flex-direction: column; justify-content: center;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='';">
      <h3 style="font-size: 0.875rem; margin-bottom: 0.5rem; opacity: 0.9;">ä»Šæœˆã®å£²ä¸Š</h3>
      <p style="font-size: 2.5rem; font-weight: 700; margin: 0.5rem 0;" id="monthlyRevenue">-</p>
      <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;" id="monthlyRevenueTrend"></div>
    </div>
  </a>
</div>

<!-- æœˆåˆ¥å£²ä¸Šã‚°ãƒ©ãƒ• -->
<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h2 class="card-title" style="margin: 0;">æœˆåˆ¥å£²ä¸Šæ¨ç§»</h2>
  </div>

  <!-- æœˆé¸æŠãƒœã‚¿ãƒ³ -->
  <div id="monthSelector" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; justify-content: center;">
    <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
  </div>

  <div id="revenueChartContainer">
    <p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>
</div>

<!-- æ–½è¨­åˆ©ç”¨çŠ¶æ³ -->
<div class="card">
  <h2 class="card-title">æ–½è¨­åˆ©ç”¨çŠ¶æ³</h2>
  <div id="roomUsageContainer">
    <p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>
</div>

<!-- 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 1.5rem;">
  <!-- æœ€è¿‘ã®ç”³è«‹ -->
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h2 class="card-title" style="margin: 0;">æœ€è¿‘ã®ç”³è«‹</h2>
      <a href="/staff/reservations" class="btn" style="padding: 0.5rem 1rem; background-color: #95a5a6; color: white; text-decoration: none;">ã™ã¹ã¦è¦‹ã‚‹ â†’</a>
    </div>
    <div id="recentApplicationsContainer">
      <p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>

  <!-- æœ¬æ—¥ã®åˆ©ç”¨ -->
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h2 class="card-title" style="margin: 0;">æœ¬æ—¥ã®åˆ©ç”¨</h2>
      <a href="/staff/usages" class="btn" style="padding: 0.5rem 1rem; background-color: #95a5a6; color: white; text-decoration: none;">ã™ã¹ã¦è¦‹ã‚‹ â†’</a>
    </div>
    <div id="todayUsagesContainer">
      <p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>
</div>

<!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="card">
  <h2 class="card-title">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
    <a href="/staff/reservations" class="btn btn-primary" style="padding: 1rem; text-decoration: none; text-align: center;">
      ğŸ“… äºˆç´„ç®¡ç†
    </a>
    <a href="/staff/usages" class="btn" style="padding: 1rem; text-decoration: none; text-align: center; background-color: #27ae60; color: white;">
      ğŸ“Š åˆ©ç”¨è¨˜éŒ²
    </a>
    <a href="/staff/users" class="btn" style="padding: 1rem; text-decoration: none; text-align: center; background-color: #f39c12; color: white;">
      ğŸ‘¥ åˆ©ç”¨è€…ç®¡ç†
    </a>
    <a href="/staff/reports" class="btn" style="padding: 1rem; text-decoration: none; text-align: center; background-color: #9b59b6; color: white;">
      ğŸ“ˆ ãƒ¬ãƒãƒ¼ãƒˆ
    </a>
  </div>
</div>

<script>


// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°
function refreshDashboard() {
  loadDashboardData();
}

// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
async function loadDashboardData() {
  updateLastUpdateTime();

  try {
    const res = await fetch('/api/staff/dashboard/stats', {
      credentials: 'include',
      });
    const stats = await res.json();

    // çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
    document.getElementById('todayReservations').textContent = stats.todayReservations || 0;
    document.getElementById('upcomingReservations').textContent = stats.upcomingReservations || 0;
    document.getElementById('pendingPayments').textContent = stats.pendingPayments || 0;
    document.getElementById('monthlyRevenue').textContent = 'Â¥' + (stats.monthlyRevenue || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0});

    // ãƒˆãƒ¬ãƒ³ãƒ‰è¡¨ç¤ºï¼ˆãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ï¼‰
    document.getElementById('todayReservationsTrend').textContent = 'å‰æ—¥æ¯” +2ä»¶';
    document.getElementById('upcomingReservationsTrend').textContent = 'å…ˆé€±æ¯” +5ä»¶';
    document.getElementById('pendingPaymentsTrend').textContent = stats.pendingPayments > 0 ? 'è¦å¯¾å¿œ' : 'å•é¡Œãªã—';
    document.getElementById('monthlyRevenueTrend').textContent = 'å‰æœˆæ¯” +12%';

    // æœ€è¿‘ã®ç”³è«‹
    displayRecentApplications(stats.recentApplications);

    // æœ¬æ—¥ã®åˆ©ç”¨
    displayTodayUsages(stats.todayUsages);
  } catch (error) {
    console.error('Error loading dashboard stats:', error);
  }

  // æœˆé¸æŠãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
  generateMonthSelector();

  // æœˆåˆ¥å£²ä¸Šã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿
  loadRevenueChart();

  // æ–½è¨­åˆ©ç”¨çŠ¶æ³ã‚’èª­ã¿è¾¼ã¿
  loadRoomUsage();
}

// æœ€è¿‘ã®ç”³è«‹ã‚’è¡¨ç¤º
function displayRecentApplications(applications) {
  if (applications && applications.length > 0) {
    const html = `
      <div style="max-height: 400px; overflow-y: auto;">
        ${applications.slice(0, 5).map(app => `
          <div style="padding: 1rem; border-bottom: 1px solid #ecf0f1; display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
              <div style="font-weight: 600; margin-bottom: 0.25rem;">${app.eventName || 'ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆåãªã—ï¼‰'}</div>
              <div style="font-size: 0.875rem; color: #7f8c8d;">
                ${app.applicantName} Â· Â¥${(app.totalAmount || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0})}
              </div>
            </div>
            <div>
              <span class="badge badge-${app.paymentStatus === 'paid' ? 'success' : 'warning'}">
                ${app.paymentStatus === 'paid' ? 'æ”¯æ‰•æ¸ˆ' : 'æœªæ±ºæ¸ˆ'}
              </span>
            </div>
          </div>
        `).join('')}
      </div>
    `;
    document.getElementById('recentApplicationsContainer').innerHTML = html;
  } else {
    document.getElementById('recentApplicationsContainer').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 2rem;">ç”³è«‹ãŒã‚ã‚Šã¾ã›ã‚“</p>';
  }
}

// æœ¬æ—¥ã®åˆ©ç”¨ã‚’è¡¨ç¤º
function displayTodayUsages(usages) {
  if (usages && usages.length > 0) {
    const html = `
      <div style="max-height: 400px; overflow-y: auto;">
        ${usages.map(usage => {
          const slots = [];
          if (usage.useMorning) slots.push('åˆå‰');
          if (usage.useAfternoon) slots.push('åˆå¾Œ');
          if (usage.useEvening) slots.push('å¤œé–“');

          return `
            <div style="padding: 1rem; border-bottom: 1px solid #ecf0f1;">
              <div style="font-weight: 600; margin-bottom: 0.25rem;">${usage.roomName || '-'}</div>
              <div style="font-size: 0.875rem; color: #7f8c8d;">
                ${usage.eventName || '-'} Â· ${slots.join(', ')}
                ${usage.acRequested ? ' Â· AC' + (usage.acHours ? usage.acHours + 'h' : 'æœªå…¥åŠ›') : ''}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
    document.getElementById('todayUsagesContainer').innerHTML = html;
  } else {
    document.getElementById('todayUsagesContainer').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 2rem;">æœ¬æ—¥ã®åˆ©ç”¨äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>';
  }
}

// ç¾åœ¨é¸æŠä¸­ã®å¹´æœˆ
let selectedYear = new Date().getFullYear();
let selectedMonth = new Date().getMonth() + 1;

// æœˆé¸æŠãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
function generateMonthSelector() {
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth() + 1;

  const months = [];
  for (let i = 0; i < 6; i++) {
    const date = new Date(currentYear, currentMonth - 1 - i, 1);
    months.push({
      year: date.getFullYear(),
      month: date.getMonth() + 1,
      label: `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}`
    });
  }

  const selectorHtml = months.map(m => {
    const isSelected = m.year === selectedYear && m.month === selectedMonth;
    return `
      <button
        onclick="selectMonth(${m.year}, ${m.month})"
        style="padding: 0.5rem 1rem; border: 2px solid ${isSelected ? '#3498db' : '#ddd'}; background: ${isSelected ? '#3498db' : 'white'}; color: ${isSelected ? 'white' : '#333'}; border-radius: 6px; cursor: pointer; font-weight: ${isSelected ? '600' : '400'}; transition: all 0.3s;"
        onmouseover="if(!${isSelected}) { this.style.borderColor='#3498db'; this.style.backgroundColor='#f0f8ff'; }"
        onmouseout="if(!${isSelected}) { this.style.borderColor='#ddd'; this.style.backgroundColor='white'; }"
      >
        ${m.label}
      </button>
    `;
  }).join('');

  document.getElementById('monthSelector').innerHTML = selectorHtml;
}

// æœˆã‚’é¸æŠ
async function selectMonth(year, month) {
  selectedYear = year;
  selectedMonth = month;
  generateMonthSelector();
  await loadRevenueChart(year, month);
}

// æœˆåˆ¥å£²ä¸Šã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿
async function loadRevenueChart(year = selectedYear, month = selectedMonth) {
  try {
    const res = await fetch(`/api/staff/dashboard/revenue/monthly?year=${year}&month=${month}`, {
      credentials: 'include',
      });
    const data = await res.json();

    if (data.dailyRevenue && data.dailyRevenue.length > 0) {
      const maxRevenue = Math.max(...data.dailyRevenue.map(d => d.revenue || 0));

      const html = `
        <div style="padding: 1rem;">
          <div style="display: flex; align-items: flex-end; justify-content: space-around; height: 200px; gap: 0.5rem;">
            ${data.dailyRevenue.slice(0, 15).map(day => {
              const height = maxRevenue > 0 ? (day.revenue / maxRevenue * 100) : 0;
              return `
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                  <div style="font-size: 0.75rem; color: #7f8c8d; margin-bottom: 0.5rem;">
                    Â¥${(day.revenue || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0})}
                  </div>
                  <div style="width: 100%; background: linear-gradient(to top, #3498db, #5dade2); height: ${height}%; min-height: 2px; border-radius: 4px 4px 0 0;" title="Â¥${(day.revenue || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0})}"></div>
                  <div style="font-size: 0.75rem; color: #7f8c8d; margin-top: 0.5rem;">
                    ${day.date.split('-')[2]}æ—¥
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          <div style="text-align: center; margin-top: 1rem; padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
            <div style="font-size: 0.875rem; color: #7f8c8d;">${year}å¹´${month}æœˆã®ç·å£²ä¸Š</div>
            <div style="font-size: 1.5rem; font-weight: 600; color: #3498db;">Â¥${(data.totalRevenue || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0})}</div>
          </div>
        </div>
      `;
      document.getElementById('revenueChartContainer').innerHTML = html;
    } else {
      document.getElementById('revenueChartContainer').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 2rem;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    }
  } catch (error) {
    console.error('Error loading revenue chart:', error);
    document.getElementById('revenueChartContainer').innerHTML = '<p style="text-align: center; color: #e74c3c;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
  }
}

// æ–½è¨­åˆ©ç”¨çŠ¶æ³ã‚’èª­ã¿è¾¼ã¿
async function loadRoomUsage() {
  try {
    const res = await fetch('/api/staff/dashboard/rooms/usage-stats', {
      credentials: 'include',
      });
    const data = await res.json();

    if (data.rooms && data.rooms.length > 0) {
      const html = `
        <div style="padding: 1rem;">
          ${data.rooms.map(room => `
            <div style="margin-bottom: 1.5rem;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="font-weight: 600;">${room.name}</span>
                <span style="color: #7f8c8d;">
                  ${room.usageCount || 0}å› Â· Â¥${(room.totalRevenue || 0).toLocaleString('ja-JP', {maximumFractionDigits: 0})}
                </span>
              </div>
              <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="flex: 1; height: 12px; background-color: #ecf0f1; border-radius: 6px; overflow: hidden;">
                  <div style="height: 100%; background: linear-gradient(to right, #3498db, #2ecc71); width: ${room.utilizationRate || 0}%; transition: width 0.3s ease;"></div>
                </div>
                <span style="min-width: 50px; text-align: right; font-weight: 600; color: #3498db;">
                  ${room.utilizationRate || 0}%
                </span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      document.getElementById('roomUsageContainer').innerHTML = html;
    } else {
      document.getElementById('roomUsageContainer').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 2rem;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    }
  } catch (error) {
    console.error('Error loading room usage:', error);
    document.getElementById('roomUsageContainer').innerHTML = '<p style="text-align: center; color: #e74c3c;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
  }
}

// æœ€çµ‚æ›´æ–°æ™‚åˆ»ã‚’æ›´æ–°
function updateLastUpdateTime() {
  const now = new Date();
  document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('ja-JP');
}

// åˆæœŸãƒ­ãƒ¼ãƒ‰
document.addEventListener('DOMContentLoaded', () => {
  loadDashboardData();

  // 5åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°
  setInterval(loadDashboardData, 5 * 60 * 1000);
});
</script>
