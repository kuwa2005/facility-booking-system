<div class="page-header">
  <h1 class="page-title">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°</h1>
  <p class="page-description">ã‚·ã‚¹ãƒ†ãƒ ã®æ“ä½œå±¥æ­´ã¨ç›£æŸ»ãƒ­ã‚°</p>
</div>

<!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
  <div class="card" style="text-align: center;">
    <h3 style="color: #7f8c8d; font-size: 0.875rem; margin-bottom: 0.5rem;">ä»Šæ—¥ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</h3>
    <p style="font-size: 2.5rem; font-weight: 600; color: #3498db;" id="todayActivities">-</p>
  </div>
  <div class="card" style="text-align: center;">
    <h3 style="color: #7f8c8d; font-size: 0.875rem; margin-bottom: 0.5rem;">ä»Šé€±</h3>
    <p style="font-size: 2.5rem; font-weight: 600; color: #27ae60;" id="weekActivities">-</p>
  </div>
  <div class="card" style="text-align: center;">
    <h3 style="color: #7f8c8d; font-size: 0.875rem; margin-bottom: 0.5rem;">ä»Šæœˆ</h3>
    <p style="font-size: 2.5rem; font-weight: 600; color: #f39c12;" id="monthActivities">-</p>
  </div>
  <div class="card" style="text-align: center;">
    <h3 style="color: #7f8c8d; font-size: 0.875rem; margin-bottom: 0.5rem;">ç·ãƒ­ã‚°æ•°</h3>
    <p style="font-size: 2.5rem; font-weight: 600; color: #9b59b6;" id="totalActivities">-</p>
  </div>
</div>

<!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
<div class="card">
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
    <div>
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">é–‹å§‹æ—¥æ™‚</label>
      <input type="datetime-local" id="startDateTime" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    <div>
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">çµ‚äº†æ—¥æ™‚</label>
      <input type="datetime-local" id="endDateTime" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    <div>
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¨®åˆ¥</label>
      <select id="actionType" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">ã™ã¹ã¦</option>
        <option value="login">ãƒ­ã‚°ã‚¤ãƒ³</option>
        <option value="logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</option>
        <option value="create">ä½œæˆ</option>
        <option value="update">æ›´æ–°</option>
        <option value="delete">å‰Šé™¤</option>
        <option value="approve">æ‰¿èª</option>
        <option value="reject">æ‹’å¦</option>
        <option value="access_denied">ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦</option>
      </select>
    </div>
    <div>
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">å®Ÿè¡Œè€…</label>
      <input type="text" id="actorSearch" placeholder="è·å“¡åã§æ¤œç´¢..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
    </div>
  </div>
  <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
    <button onclick="loadActivityLog()" class="btn btn-primary">æ¤œç´¢</button>
    <button onclick="resetFilters()" class="btn" style="background-color: #95a5a6; color: white;">ãƒªã‚»ãƒƒãƒˆ</button>
    <button onclick="loadToday()" class="btn" style="background-color: #27ae60; color: white;">ä»Šæ—¥</button>
    <button onclick="loadYesterday()" class="btn" style="background-color: #3498db; color: white;">æ˜¨æ—¥</button>
    <button onclick="loadWeek()" class="btn" style="background-color: #f39c12; color: white;">ä»Šé€±</button>
    <button onclick="loadCustomDaysAgo()" class="btn" style="background-color: #9b59b6; color: white;">næ—¥å‰</button>
  </div>
</div>

<!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°ä¸€è¦§ -->
<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h2 class="card-title" style="margin: 0;">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°</h2>
    <div style="display: flex; gap: 1rem; align-items: center;">
      <div id="totalCount" style="color: #7f8c8d;"></div>
      <button onclick="exportToCSV()" class="btn" style="background-color: #27ae60; color: white;">ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    </div>
  </div>
  <div id="logContainer">
    <p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>
</div>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="detailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
  <div style="background-color: white; max-width: 800px; margin: 2rem auto; border-radius: 8px; padding: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="margin: 0;">ãƒ­ã‚°è©³ç´°</h2>
      <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
    </div>
    <div id="detailContent"></div>
  </div>
</div>

<script>

let currentLogs = [];
let timezoneOffset = 0; // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆåˆ†ï¼‰

// åˆæœŸãƒ­ãƒ¼ãƒ‰
document.addEventListener('DOMContentLoaded', async () => {
  await loadTimezoneSettings();
  loadStats();
  setDefaultDateRange();
  // åˆæœŸè¡¨ç¤ºæ™‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ¤œç´¢æ¡ä»¶ã§ãƒ­ã‚°ã‚’è¡¨ç¤º
  loadActivityLog();
});

// ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‹ã‚‰ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
async function loadTimezoneSettings() {
  try {
    const response = await fetch('/api/staff/settings');
    const settings = await response.json();

    // timezone_offsetãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ï¼ˆåˆ†å˜ä½ï¼‰
    if (settings.timezone_offset && settings.timezone_offset.value !== undefined && settings.timezone_offset.value !== null) {
      timezoneOffset = parseInt(settings.timezone_offset.value);
      console.log('Loaded timezone offset:', timezoneOffset, 'minutes');
    }
  } catch (error) {
    console.error('Failed to load timezone settings:', error);
  }
}

// UTCæ—¥æ™‚ã‚’ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’è€ƒæ…®ã—ã¦ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatDateTime(utcDateStr) {
  const utcDate = new Date(utcDateStr);
  // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’é©ç”¨ï¼ˆåˆ†å˜ä½ï¼‰
  const adjustedDate = new Date(utcDate.getTime() + (timezoneOffset * 60000));

  // UTCãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†ã«ï¼‰
  const year = adjustedDate.getUTCFullYear();
  const month = String(adjustedDate.getUTCMonth() + 1).padStart(2, '0');
  const day = String(adjustedDate.getUTCDate()).padStart(2, '0');
  const hours = String(adjustedDate.getUTCHours()).padStart(2, '0');
  const minutes = String(adjustedDate.getUTCMinutes()).padStart(2, '0');
  const seconds = String(adjustedDate.getUTCSeconds()).padStart(2, '0');

  return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ—¥æ™‚ç¯„å›²ã‚’è¨­å®šï¼ˆä»Šæ—¥ 00:00-23:59ï¼‰
function setDefaultDateRange() {
  const now = new Date();
  const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0);
  const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59);

  const startInput = document.getElementById('startDateTime');
  const endInput = document.getElementById('endDateTime');

  startInput.value = formatDateTimeLocal(todayStart);
  endInput.value = formatDateTimeLocal(todayEnd);
}

// datetime-localå½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatDateTimeLocal(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${year}-${month}-${day}T${hours}:${minutes}`;
}

// çµ±è¨ˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿
async function loadStats() {
  try {
    const response = await fetch('/api/staff/activity-logs/stats');
    const data = await response.json();

    if (data.success && data.stats) {
      document.getElementById('todayActivities').textContent = data.stats.today.toLocaleString();
      document.getElementById('weekActivities').textContent = data.stats.week.toLocaleString();
      document.getElementById('monthActivities').textContent = data.stats.month.toLocaleString();
      document.getElementById('totalActivities').textContent = data.stats.total.toLocaleString();
    }
  } catch (error) {
    console.error('Failed to load stats:', error);
    document.getElementById('todayActivities').textContent = '0';
    document.getElementById('weekActivities').textContent = '0';
    document.getElementById('monthActivities').textContent = '0';
    document.getElementById('totalActivities').textContent = '0';
  }
}

// ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿
async function loadActivityLog() {
  const startDateTime = document.getElementById('startDateTime').value;
  const endDateTime = document.getElementById('endDateTime').value;
  const actionType = document.getElementById('actionType').value;
  const actorSearch = document.getElementById('actorSearch').value;

  try {
    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
    const params = new URLSearchParams();
    if (startDateTime) params.append('startDate', startDateTime);
    if (endDateTime) params.append('endDate', endDateTime);
    if (actionType) params.append('actionType', actionType);
    params.append('limit', '100');

    const response = await fetch(`/api/staff/activity-logs?${params.toString()}`);
    const data = await response.json();

    if (data.success && data.logs) {
      let filteredLogs = data.logs;

      // ã‚¢ã‚¯ã‚¿ãƒ¼åã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼‰
      if (actorSearch) {
        filteredLogs = filteredLogs.filter(log =>
          log.staffName && log.staffName.includes(actorSearch)
        );
      }

      currentLogs = filteredLogs;
      displayLogs(filteredLogs);
    } else {
      currentLogs = [];
      displayLogs([]);
    }
  } catch (error) {
    console.error('Failed to load activity logs:', error);
    currentLogs = [];
    displayLogs([]);
  }
}

// ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã‹ã‚‰è¡¨ç¤ºæƒ…å ±ã‚’å–å¾—
function getActionTypeInfo(actionType) {
  const actionMap = {
    'login': { label: 'ãƒ­ã‚°ã‚¤ãƒ³', icon: 'ğŸ”', color: '#3498db' },
    'logout': { label: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ', icon: 'ğŸšª', color: '#95a5a6' },
    'create': { label: 'ä½œæˆ', icon: 'â•', color: '#27ae60' },
    'update': { label: 'æ›´æ–°', icon: 'âœï¸', color: '#f39c12' },
    'delete': { label: 'å‰Šé™¤', icon: 'ğŸ—‘ï¸', color: '#e74c3c' },
    'approve': { label: 'æ‰¿èª', icon: 'âœ…', color: '#27ae60' },
    'reject': { label: 'æ‹’å¦', icon: 'âŒ', color: '#e74c3c' },
    'access_denied': { label: 'ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦', icon: 'ğŸš«', color: '#c0392b' },
    'reservation_create': { label: 'äºˆç´„ä½œæˆ', icon: 'â•', color: '#27ae60' },
    'reservation_update': { label: 'äºˆç´„æ›´æ–°', icon: 'âœï¸', color: '#f39c12' },
    'reservation_cancel': { label: 'äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«', icon: 'âŒ', color: '#e74c3c' },
    'user_create': { label: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ', icon: 'ğŸ‘¤', color: '#9b59b6' },
    'user_update': { label: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°', icon: 'ğŸ‘¤', color: '#9b59b6' },
    'user_delete': { label: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤', icon: 'ğŸ—‘ï¸', color: '#e74c3c' },
    'staff_create': { label: 'è·å“¡ä½œæˆ', icon: 'ğŸ‘¥', color: '#16a085' },
    'staff_update': { label: 'è·å“¡æ›´æ–°', icon: 'ğŸ‘¥', color: '#16a085' },
    'settings_update': { label: 'è¨­å®šå¤‰æ›´', icon: 'âš™ï¸', color: '#16a085' },
  };

  return actionMap[actionType] || { label: actionType, icon: 'ğŸ“', color: '#7f8c8d' };
}

// ãƒ­ã‚°ã‚’è¡¨ç¤º
function displayLogs(logs) {
  if (logs && logs.length > 0) {
    document.getElementById('totalCount').textContent = `å…¨ ${logs.length} ä»¶`;

    const html = `
      <div style="overflow-x: auto;">
        <table class="table">
          <thead>
            <tr>
              <th>æ—¥æ™‚</th>
              <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
              <th>å®Ÿè¡Œè€…</th>
              <th>IPã‚¢ãƒ‰ãƒ¬ã‚¹</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${logs.map(log => {
              const actionInfo = getActionTypeInfo(log.actionType);
              return `
                <tr>
                  <td>${formatDateTime(log.createdAt)}</td>
                  <td>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="font-size: 1.25rem;">${actionInfo.icon}</span>
                      <span class="badge" style="background-color: ${actionInfo.color};">${actionInfo.label}</span>
                    </div>
                  </td>
                  <td>${log.staffName || 'ã‚·ã‚¹ãƒ†ãƒ '}</td>
                  <td style="font-family: monospace; font-size: 0.875rem;">${log.ipAddress || '-'}</td>
                  <td>
                    <button onclick="showDetail(${log.id})" class="btn btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">è©³ç´°</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;
    document.getElementById('logContainer').innerHTML = html;
  } else {
    document.getElementById('totalCount').textContent = '';
    document.getElementById('logContainer').innerHTML = '<p style="text-align: center; color: #7f8c8d;">ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>';
  }
}

// ãƒ­ã‚°è©³ç´°ã‚’è¡¨ç¤º
function showDetail(id) {
  const log = currentLogs.find(l => l.id === id);
  if (!log) return;

  const actionInfo = getActionTypeInfo(log.actionType);

  const html = `
    <div style="display: grid; gap: 1.5rem;">
      <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
        <h3 style="margin-bottom: 1rem; color: #2c3e50;">åŸºæœ¬æƒ…å ±</h3>
        <div style="display: grid; gap: 0.75rem;">
          <div><strong>ãƒ­ã‚°ID:</strong> ${log.id}</div>
          <div><strong>æ—¥æ™‚:</strong> ${formatDateTime(log.createdAt)}</div>
          <div><strong>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</strong> ${actionInfo.icon} ${actionInfo.label}</div>
          <div><strong>å®Ÿè¡Œè€…:</strong> ${log.staffName || 'ã‚·ã‚¹ãƒ†ãƒ '}</div>
          <div><strong>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</strong> ${log.staffEmail || '-'}</div>
          <div><strong>IPã‚¢ãƒ‰ãƒ¬ã‚¹:</strong> ${log.ipAddress || '-'}</div>
        </div>
      </div>

      <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
        <h3 style="margin-bottom: 1rem; color: #2c3e50;">å¯¾è±¡æƒ…å ±</h3>
        <div style="display: grid; gap: 0.75rem;">
          <div><strong>å¯¾è±¡ç¨®åˆ¥:</strong> ${log.targetType || '-'}</div>
          <div><strong>å¯¾è±¡ID:</strong> ${log.targetId || '-'}</div>
        </div>
      </div>

      <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
        <h3 style="margin-bottom: 1rem; color: #2c3e50;">è©³ç´°</h3>
        <div>${log.description || 'ãªã—'}</div>
      </div>

      ${log.userAgent ? `
        <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
          <h3 style="margin-bottom: 1rem; color: #2c3e50;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</h3>
          <div style="word-break: break-all; font-size: 0.875rem; font-family: monospace;">${log.userAgent}</div>
        </div>
      ` : ''}

      <div style="display: flex; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #ecf0f1;">
        <button onclick="closeDetailModal()" class="btn" style="background-color: #95a5a6; color: white;">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  `;

  document.getElementById('detailContent').innerHTML = html;
  document.getElementById('detailModal').style.display = 'block';
}

// è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeDetailModal() {
  document.getElementById('detailModal').style.display = 'none';
}

// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
function resetFilters() {
  setDefaultDateRange();
  document.getElementById('actionType').value = '';
  document.getElementById('actorSearch').value = '';
}

// ä»Šæ—¥ã®ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼ˆ00:00-23:59ï¼‰
function loadToday() {
  const now = new Date();
  const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0);
  const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59);

  document.getElementById('startDateTime').value = formatDateTimeLocal(todayStart);
  document.getElementById('endDateTime').value = formatDateTimeLocal(todayEnd);
  document.getElementById('actionType').value = '';
  document.getElementById('actorSearch').value = '';

  loadActivityLog();
}

// æ˜¨æ—¥ã®ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼ˆ00:00-23:59ï¼‰
function loadYesterday() {
  const now = new Date();
  const yesterdayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 0, 0);
  const yesterdayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 23, 59);

  document.getElementById('startDateTime').value = formatDateTimeLocal(yesterdayStart);
  document.getElementById('endDateTime').value = formatDateTimeLocal(yesterdayEnd);
  document.getElementById('actionType').value = '';
  document.getElementById('actorSearch').value = '';

  loadActivityLog();
}

// ä»Šé€±ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
function loadWeek() {
  const now = new Date();
  const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  weekAgo.setHours(0, 0, 0, 0);
  const endTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59);

  document.getElementById('startDateTime').value = formatDateTimeLocal(weekAgo);
  document.getElementById('endDateTime').value = formatDateTimeLocal(endTime);
  document.getElementById('actionType').value = '';
  document.getElementById('actorSearch').value = '';

  loadActivityLog();
}

// næ—¥å‰ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
function loadCustomDaysAgo() {
  const daysAgo = prompt('ä½•æ—¥å‰ã®ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿï¼ˆæ•°å­—ã‚’å…¥åŠ›ï¼‰', '3');

  if (daysAgo === null || daysAgo === '') {
    return;
  }

  const days = parseInt(daysAgo);
  if (isNaN(days) || days < 0) {
    alert('æ­£ã—ã„æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  const now = new Date();
  const targetStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - days, 0, 0);
  const targetEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() - days, 23, 59);

  document.getElementById('startDateTime').value = formatDateTimeLocal(targetStart);
  document.getElementById('endDateTime').value = formatDateTimeLocal(targetEnd);
  document.getElementById('actionType').value = '';
  document.getElementById('actorSearch').value = '';

  loadActivityLog();
}

// CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
function exportToCSV() {
  if (!currentLogs || currentLogs.length === 0) {
    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  const headers = ['ID', 'æ—¥æ™‚', 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³', 'å®Ÿè¡Œè€…', 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', 'IPã‚¢ãƒ‰ãƒ¬ã‚¹', 'å¯¾è±¡ç¨®åˆ¥', 'å¯¾è±¡ID', 'è©³ç´°'];

  const rows = currentLogs.map(log => {
    const actionInfo = getActionTypeInfo(log.actionType);
    return [
      log.id,
      formatDateTime(log.createdAt),
      actionInfo.label,
      log.staffName || 'ã‚·ã‚¹ãƒ†ãƒ ',
      log.staffEmail || '-',
      log.ipAddress || '-',
      log.targetType || '-',
      log.targetId || '-',
      log.description || 'ãªã—'
    ];
  });

  const csvContent = [
    headers.join(','),
    ...rows.map(row => row.map(cell => {
      const cellStr = String(cell);
      if (cellStr.includes(',') || cellStr.includes('\n') || cellStr.includes('"')) {
        return '"' + cellStr.replace(/"/g, '""') + '"';
      }
      return cellStr;
    }).join(','))
  ].join('\n');

  const bom = '\uFEFF';
  const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });

  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  const now = new Date();
  const filename = `activity_log_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}.csv`;

  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('detailModal').addEventListener('click', (e) => {
  if (e.target.id === 'detailModal') {
    closeDetailModal();
  }
});
</script>
