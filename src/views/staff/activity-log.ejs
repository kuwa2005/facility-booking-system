<div class="page-header">
  <h1 class="page-title">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°</h1>
  <p class="page-description">ã‚·ã‚¹ãƒ†ãƒ ã®æ“ä½œå±¥æ­´ã¨ç›£æŸ»ãƒ­ã‚°</p>
</div>

<!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
  <div class="card" style="text-align: center;">
    <h3 style="color: #7f8c8d; font-size: 0.875rem; margin-bottom: 0.5rem;">ä»Šæ—¥ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</h3>
    <p style="font-size: 2.5rem; font-weight: 600; color: #3498db;" id="todayActivities">-</p>
  </div>
  <div class="card" style="text-align: center;">
    <h3 style="color: #7f8c8d; font-size: 0.875rem; margin-bottom: 0.5rem;">ä»Šé€±</h3>
    <p style="font-size: 2.5rem; font-weight: 600; color: #27ae60;" id="weekActivities">-</p>
  </div>
  <div class="card" style="text-align: center;">
    <h3 style="color: #7f8c8d; font-size: 0.875rem; margin-bottom: 0.5rem;">ä»Šæœˆ</h3>
    <p style="font-size: 2.5rem; font-weight: 600; color: #f39c12;" id="monthActivities">-</p>
  </div>
  <div class="card" style="text-align: center;">
    <h3 style="color: #7f8c8d; font-size: 0.875rem; margin-bottom: 0.5rem;">ç·ãƒ­ã‚°æ•°</h3>
    <p style="font-size: 2.5rem; font-weight: 600; color: #9b59b6;" id="totalActivities">-</p>
  </div>
</div>

<!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
<div class="card">
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
    <div>
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">é–‹å§‹æ—¥æ™‚</label>
      <input type="datetime-local" id="startDateTime" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    <div>
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">çµ‚äº†æ—¥æ™‚</label>
      <input type="datetime-local" id="endDateTime" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    <div>
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¨®åˆ¥</label>
      <select id="actionType" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">ã™ã¹ã¦</option>
        <option value="login">ãƒ­ã‚°ã‚¤ãƒ³</option>
        <option value="logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</option>
        <option value="reservation_create">äºˆç´„ä½œæˆ</option>
        <option value="reservation_update">äºˆç´„æ›´æ–°</option>
        <option value="reservation_cancel">äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
        <option value="user_create">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ</option>
        <option value="user_update">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°</option>
        <option value="user_delete">ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤</option>
        <option value="staff_create">è·å“¡ä½œæˆ</option>
        <option value="staff_update">è·å“¡æ›´æ–°</option>
        <option value="settings_update">è¨­å®šå¤‰æ›´</option>
      </select>
    </div>
    <div>
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">å®Ÿè¡Œè€…</label>
      <input type="text" id="actorSearch" placeholder="è·å“¡åã§æ¤œç´¢..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
    </div>
  </div>
  <div style="display: flex; gap: 1rem;">
    <button onclick="loadActivityLog()" class="btn btn-primary">æ¤œç´¢</button>
    <button onclick="resetFilters()" class="btn" style="background-color: #95a5a6; color: white;">ãƒªã‚»ãƒƒãƒˆ</button>
    <button onclick="loadToday()" class="btn" style="background-color: #27ae60; color: white;">ä»Šæ—¥</button>
    <button onclick="loadWeek()" class="btn" style="background-color: #f39c12; color: white;">ä»Šé€±</button>
  </div>
</div>

<!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°ä¸€è¦§ -->
<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h2 class="card-title" style="margin: 0;">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°</h2>
    <div style="display: flex; gap: 1rem; align-items: center;">
      <div id="totalCount" style="color: #7f8c8d;"></div>
      <button onclick="exportToCSV()" class="btn" style="background-color: #27ae60; color: white;">ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    </div>
  </div>
  <div id="logContainer">
    <p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>
</div>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="detailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
  <div style="background-color: white; max-width: 800px; margin: 2rem auto; border-radius: 8px; padding: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="margin: 0;">ãƒ­ã‚°è©³ç´°</h2>
      <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
    </div>
    <div id="detailContent"></div>
  </div>
</div>

<script>

let currentLogs = [];

// åˆæœŸãƒ­ãƒ¼ãƒ‰
document.addEventListener('DOMContentLoaded', () => {
  loadStats();
  setDefaultDateRange();
  // åˆæœŸè¡¨ç¤ºæ™‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ¤œç´¢æ¡ä»¶ã§ãƒ­ã‚°ã‚’è¡¨ç¤º
  loadActivityLog();
});

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ—¥æ™‚ç¯„å›²ã‚’è¨­å®šï¼ˆä»Šæ—¥ï¼‰
function setDefaultDateRange() {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  const startInput = document.getElementById('startDateTime');
  const endInput = document.getElementById('endDateTime');

  startInput.value = formatDateTimeLocal(today);
  endInput.value = formatDateTimeLocal(now);
}

// datetime-localå½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatDateTimeLocal(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${year}-${month}-${day}T${hours}:${minutes}`;
}

// çµ±è¨ˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ï¼‰
function loadStats() {
  document.getElementById('todayActivities').textContent = '42';
  document.getElementById('weekActivities').textContent = '267';
  document.getElementById('monthActivities').textContent = '1,234';
  document.getElementById('totalActivities').textContent = '15,678';
}

// ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ï¼‰
function loadActivityLog() {
  const startDateTime = document.getElementById('startDateTime').value;
  const endDateTime = document.getElementById('endDateTime').value;
  const actionType = document.getElementById('actionType').value;
  const actorSearch = document.getElementById('actorSearch').value;

  // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿
  const demoLogs = generateDemoLogs();

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  let filteredLogs = demoLogs;
  if (actionType) {
    filteredLogs = filteredLogs.filter(log => log.action === actionType);
  }
  if (actorSearch) {
    filteredLogs = filteredLogs.filter(log => log.actor.includes(actorSearch));
  }

  currentLogs = filteredLogs;
  displayLogs(filteredLogs);
}

// ãƒ‡ãƒ¢ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
function generateDemoLogs() {
  const actions = [
    { action: 'login', label: 'ãƒ­ã‚°ã‚¤ãƒ³', icon: 'ğŸ”', color: '#3498db' },
    { action: 'logout', label: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ', icon: 'ğŸšª', color: '#95a5a6' },
    { action: 'reservation_create', label: 'äºˆç´„ä½œæˆ', icon: 'â•', color: '#27ae60' },
    { action: 'reservation_update', label: 'äºˆç´„æ›´æ–°', icon: 'âœï¸', color: '#f39c12' },
    { action: 'reservation_cancel', label: 'äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«', icon: 'âŒ', color: '#e74c3c' },
    { action: 'user_update', label: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°', icon: 'ğŸ‘¤', color: '#9b59b6' },
    { action: 'settings_update', label: 'è¨­å®šå¤‰æ›´', icon: 'âš™ï¸', color: '#16a085' },
  ];

  const actors = ['ç®¡ç†è€… å¤ªéƒ', 'è·å“¡ èŠ±å­', 'è·å“¡ æ¬¡éƒ', 'ã‚·ã‚¹ãƒ†ãƒ '];
  const logs = [];

  for (let i = 0; i < 50; i++) {
    const actionData = actions[Math.floor(Math.random() * actions.length)];
    const timestamp = new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000);

    logs.push({
      id: i + 1,
      action: actionData.action,
      label: actionData.label,
      icon: actionData.icon,
      color: actionData.color,
      actor: actors[Math.floor(Math.random() * actors.length)],
      timestamp: timestamp.toISOString(),
      ipAddress: `192.168.1.${Math.floor(Math.random() * 255)}`,
      details: `è©³ç´°æƒ…å ±: ${actionData.label}ã®æ“ä½œã‚’å®Ÿè¡Œã—ã¾ã—ãŸ`,
      targetType: 'reservation',
      targetId: Math.floor(Math.random() * 1000)
    });
  }

  return logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
}

// ãƒ­ã‚°ã‚’è¡¨ç¤º
function displayLogs(logs) {
  if (logs && logs.length > 0) {
    document.getElementById('totalCount').textContent = `å…¨ ${logs.length} ä»¶`;

    const html = `
      <div style="overflow-x: auto;">
        <table class="table">
          <thead>
            <tr>
              <th>æ—¥æ™‚</th>
              <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
              <th>å®Ÿè¡Œè€…</th>
              <th>IPã‚¢ãƒ‰ãƒ¬ã‚¹</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${logs.map(log => `
              <tr>
                <td>${new Date(log.timestamp).toLocaleString('ja-JP')}</td>
                <td>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.25rem;">${log.icon}</span>
                    <span class="badge" style="background-color: ${log.color};">${log.label}</span>
                  </div>
                </td>
                <td>${log.actor}</td>
                <td style="font-family: monospace; font-size: 0.875rem;">${log.ipAddress}</td>
                <td>
                  <button onclick="showDetail(${log.id})" class="btn btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">è©³ç´°</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
    document.getElementById('logContainer').innerHTML = html;
  } else {
    document.getElementById('totalCount').textContent = '';
    document.getElementById('logContainer').innerHTML = '<p style="text-align: center; color: #7f8c8d;">ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>';
  }
}

// ãƒ­ã‚°è©³ç´°ã‚’è¡¨ç¤º
function showDetail(id) {
  const log = currentLogs.find(l => l.id === id);
  if (!log) return;

  const html = `
    <div style="display: grid; gap: 1.5rem;">
      <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
        <h3 style="margin-bottom: 1rem; color: #2c3e50;">åŸºæœ¬æƒ…å ±</h3>
        <div style="display: grid; gap: 0.75rem;">
          <div><strong>ãƒ­ã‚°ID:</strong> ${log.id}</div>
          <div><strong>æ—¥æ™‚:</strong> ${new Date(log.timestamp).toLocaleString('ja-JP')}</div>
          <div><strong>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</strong> ${log.icon} ${log.label}</div>
          <div><strong>å®Ÿè¡Œè€…:</strong> ${log.actor}</div>
          <div><strong>IPã‚¢ãƒ‰ãƒ¬ã‚¹:</strong> ${log.ipAddress}</div>
        </div>
      </div>

      <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
        <h3 style="margin-bottom: 1rem; color: #2c3e50;">å¯¾è±¡æƒ…å ±</h3>
        <div style="display: grid; gap: 0.75rem;">
          <div><strong>å¯¾è±¡ç¨®åˆ¥:</strong> ${log.targetType}</div>
          <div><strong>å¯¾è±¡ID:</strong> ${log.targetId}</div>
        </div>
      </div>

      <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
        <h3 style="margin-bottom: 1rem; color: #2c3e50;">è©³ç´°</h3>
        <div>${log.details}</div>
      </div>

      <div style="display: flex; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #ecf0f1;">
        <button onclick="closeDetailModal()" class="btn" style="background-color: #95a5a6; color: white;">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  `;

  document.getElementById('detailContent').innerHTML = html;
  document.getElementById('detailModal').style.display = 'block';
}

// è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeDetailModal() {
  document.getElementById('detailModal').style.display = 'none';
}

// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
function resetFilters() {
  setDefaultDateRange();
  document.getElementById('actionType').value = '';
  document.getElementById('actorSearch').value = '';
}

// ä»Šæ—¥ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
function loadToday() {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  document.getElementById('startDateTime').value = formatDateTimeLocal(today);
  document.getElementById('endDateTime').value = formatDateTimeLocal(now);
  document.getElementById('actionType').value = '';
  document.getElementById('actorSearch').value = '';

  loadActivityLog();
}

// ä»Šé€±ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
function loadWeek() {
  const now = new Date();
  const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

  document.getElementById('startDateTime').value = formatDateTimeLocal(weekAgo);
  document.getElementById('endDateTime').value = formatDateTimeLocal(now);
  document.getElementById('actionType').value = '';
  document.getElementById('actorSearch').value = '';

  loadActivityLog();
}

// CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
function exportToCSV() {
  if (!currentLogs || currentLogs.length === 0) {
    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  const headers = ['ID', 'æ—¥æ™‚', 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³', 'å®Ÿè¡Œè€…', 'IPã‚¢ãƒ‰ãƒ¬ã‚¹', 'å¯¾è±¡ç¨®åˆ¥', 'å¯¾è±¡ID', 'è©³ç´°'];

  const rows = currentLogs.map(log => [
    log.id,
    new Date(log.timestamp).toLocaleString('ja-JP'),
    log.label,
    log.actor,
    log.ipAddress,
    log.targetType,
    log.targetId,
    log.details
  ]);

  const csvContent = [
    headers.join(','),
    ...rows.map(row => row.map(cell => {
      const cellStr = String(cell);
      if (cellStr.includes(',') || cellStr.includes('\n') || cellStr.includes('"')) {
        return '"' + cellStr.replace(/"/g, '""') + '"';
      }
      return cellStr;
    }).join(','))
  ].join('\n');

  const bom = '\uFEFF';
  const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });

  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  const now = new Date();
  const filename = `activity_log_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}.csv`;

  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('detailModal').addEventListener('click', (e) => {
  if (e.target.id === 'detailModal') {
    closeDetailModal();
  }
});
</script>
