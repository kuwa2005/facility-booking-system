<div class="page-header">
  <h1 class="page-title">ãƒ¬ãƒãƒ¼ãƒˆãƒ»çµ±è¨ˆ</h1>
  <p class="page-description">å£²ä¸Šã€åˆ©ç”¨çŠ¶æ³ã€çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª</p>
</div>

<!-- ãƒ¬ãƒãƒ¼ãƒˆé¸æŠ -->
<div class="card">
  <h2 class="card-title">ãƒ¬ãƒãƒ¼ãƒˆã‚’é¸æŠ</h2>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
    <button onclick="showRevenueReport()" class="btn btn-primary" style="padding: 1.5rem; text-align: left;">
      <div style="font-size: 1.25rem; margin-bottom: 0.5rem;">ğŸ’° å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ</div>
      <div style="font-size: 0.875rem; opacity: 0.9;">æœˆåˆ¥ãƒ»æœŸé–“åˆ¥ã®å£²ä¸Šçµ±è¨ˆ</div>
    </button>
    <button onclick="showRoomUsageReport()" class="btn" style="padding: 1.5rem; text-align: left; background-color: #27ae60; color: white;">
      <div style="font-size: 1.25rem; margin-bottom: 0.5rem;">ğŸ¢ æ–½è¨­åˆ©ç”¨çµ±è¨ˆ</div>
      <div style="font-size: 0.875rem; opacity: 0.9;">éƒ¨å±‹ã”ã¨ã®åˆ©ç”¨çŠ¶æ³</div>
    </button>
    <button onclick="showUserStatistics()" class="btn" style="padding: 1.5rem; text-align: left; background-color: #f39c12; color: white;">
      <div style="font-size: 1.25rem; margin-bottom: 0.5rem;">ğŸ‘¥ åˆ©ç”¨è€…çµ±è¨ˆ</div>
      <div style="font-size: 0.875rem; opacity: 0.9;">ç™»éŒ²è€…æ•°ãƒ»ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</div>
    </button>
    <button onclick="showDashboardStats()" class="btn" style="padding: 1.5rem; text-align: left; background-color: #9b59b6; color: white;">
      <div style="font-size: 1.25rem; margin-bottom: 0.5rem;">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆ</div>
      <div style="font-size: 0.5rem; opacity: 0.9;">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµ±è¨ˆæƒ…å ±</div>
    </button>
  </div>
</div>

<!-- ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<div id="reportContainer"></div>

<script>


// å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
async function showRevenueReport() {
  document.getElementById('reportContainer').innerHTML = '<div class="card"><p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p></div>';

  try {
    // ç¾åœ¨ã®å¹´æœˆã‚’å–å¾—
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;

    const res = await fetch(`/api/staff/dashboard/revenue/monthly?year=${currentYear}&month=${currentMonth}`, {
      credentials: 'include',
      });
    const data = await res.json();

    const html = `
      <div class="card">
        <h2 class="card-title">ğŸ’° å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆï¼ˆ${currentYear}å¹´${currentMonth}æœˆï¼‰</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
          <div style="padding: 1.5rem; background-color: #d4edda; border-radius: 8px;">
            <div style="font-size: 0.875rem; color: #155724; margin-bottom: 0.5rem;">ç·å£²ä¸Š</div>
            <div style="font-size: 2rem; font-weight: 600; color: #155724;">Â¥${(data.totalRevenue || 0).toLocaleString()}</div>
          </div>
          <div style="padding: 1.5rem; background-color: #d1ecf1; border-radius: 8px;">
            <div style="font-size: 0.875rem; color: #0c5460; margin-bottom: 0.5rem;">äºˆç´„ä»¶æ•°</div>
            <div style="font-size: 2rem; font-weight: 600; color: #0c5460;">${data.totalReservations || 0}ä»¶</div>
          </div>
          <div style="padding: 1.5rem; background-color: #fff3cd; border-radius: 8px;">
            <div style="font-size: 0.875rem; color: #856404; margin-bottom: 0.5rem;">å¹³å‡å˜ä¾¡</div>
            <div style="font-size: 2rem; font-weight: 600; color: #856404;">Â¥${data.averageAmount ? Math.round(data.averageAmount).toLocaleString() : 0}</div>
          </div>
        </div>

        ${data.dailyRevenue && data.dailyRevenue.length > 0 ? `
          <h3 style="margin-bottom: 1rem;">æ—¥åˆ¥å£²ä¸Š</h3>
          <div style="overflow-x: auto;">
            <table class="table">
              <thead>
                <tr>
                  <th>æ—¥ä»˜</th>
                  <th>å£²ä¸Š</th>
                  <th>äºˆç´„ä»¶æ•°</th>
                </tr>
              </thead>
              <tbody>
                ${data.dailyRevenue.map(day => `
                  <tr>
                    <td>${day.date}</td>
                    <td>Â¥${(day.revenue || 0).toLocaleString()}</td>
                    <td>${day.count || 0}ä»¶</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : '<p style="text-align: center; color: #7f8c8d; margin-top: 2rem;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>'}
      </div>
    `;

    document.getElementById('reportContainer').innerHTML = html;
  } catch (error) {
    console.error('Error loading revenue report:', error);
    document.getElementById('reportContainer').innerHTML = '<div class="card"><p style="text-align: center; color: #e74c3c;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
  }
}

// æ–½è¨­åˆ©ç”¨çµ±è¨ˆã‚’è¡¨ç¤º
async function showRoomUsageReport() {
  document.getElementById('reportContainer').innerHTML = '<div class="card"><p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p></div>';

  try {
    const res = await fetch('/api/staff/dashboard/rooms/usage-stats', {
      credentials: 'include',
      });
    const data = await res.json();

    const html = `
      <div class="card">
        <h2 class="card-title">ğŸ¢ æ–½è¨­åˆ©ç”¨çµ±è¨ˆ</h2>
        ${data.rooms && data.rooms.length > 0 ? `
          <div style="overflow-x: auto;">
            <table class="table">
              <thead>
                <tr>
                  <th>æ–½è¨­å</th>
                  <th>åˆ©ç”¨å›æ•°</th>
                  <th>ç·å£²ä¸Š</th>
                  <th>åˆ©ç”¨ç‡</th>
                </tr>
              </thead>
              <tbody>
                ${data.rooms.map(room => `
                  <tr>
                    <td><strong>${room.name}</strong></td>
                    <td>${room.usageCount || 0}å›</td>
                    <td>Â¥${(room.totalRevenue || 0).toLocaleString()}</td>
                    <td>
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="flex: 1; height: 8px; background-color: #ecf0f1; border-radius: 4px; overflow: hidden;">
                          <div style="height: 100%; background-color: #3498db; width: ${room.utilizationRate || 0}%;"></div>
                        </div>
                        <span style="min-width: 50px; text-align: right;">${room.utilizationRate || 0}%</span>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : '<p style="text-align: center; color: #7f8c8d; margin-top: 2rem;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>'}
      </div>
    `;

    document.getElementById('reportContainer').innerHTML = html;
  } catch (error) {
    console.error('Error loading room usage report:', error);
    document.getElementById('reportContainer').innerHTML = '<div class="card"><p style="text-align: center; color: #e74c3c;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
  }
}

// åˆ©ç”¨è€…çµ±è¨ˆã‚’è¡¨ç¤º
async function showUserStatistics() {
  document.getElementById('reportContainer').innerHTML = '<div class="card"><p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p></div>';

  try {
    const res = await fetch('/api/staff/users/stats/summary', {
      credentials: 'include',
      });
    const data = await res.json();

    const html = `
      <div class="card">
        <h2 class="card-title">ğŸ‘¥ åˆ©ç”¨è€…çµ±è¨ˆ</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
          <div style="padding: 1.5rem; background-color: #d1ecf1; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.875rem; color: #0c5460; margin-bottom: 0.5rem;">ç·åˆ©ç”¨è€…æ•°</div>
            <div style="font-size: 2.5rem; font-weight: 600; color: #0c5460;">${data.totalUsers || 0}</div>
          </div>
          <div style="padding: 1.5rem; background-color: #d4edda; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.875rem; color: #155724; margin-bottom: 0.5rem;">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</div>
            <div style="font-size: 2.5rem; font-weight: 600; color: #155724;">${data.activeUsers || 0}</div>
          </div>
          <div style="padding: 1.5rem; background-color: #fff3cd; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.875rem; color: #856404; margin-bottom: 0.5rem;">ä»Šæœˆã®æ–°è¦</div>
            <div style="font-size: 2.5rem; font-weight: 600; color: #856404;">${data.newUsersThisMonth || 0}</div>
          </div>
          <div style="padding: 1.5rem; background-color: #e7d1f5; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.875rem; color: #6f2c91; margin-bottom: 0.5rem;">ãƒ¡ãƒ¼ãƒ«èªè¨¼æ¸ˆ</div>
            <div style="font-size: 2.5rem; font-weight: 600; color: #6f2c91;">${data.verifiedUsers || 0}</div>
          </div>
        </div>
      </div>
    `;

    document.getElementById('reportContainer').innerHTML = html;
  } catch (error) {
    console.error('Error loading user statistics:', error);
    document.getElementById('reportContainer').innerHTML = '<div class="card"><p style="text-align: center; color: #e74c3c;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
  }
}

// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆã‚’è¡¨ç¤º
async function showDashboardStats() {
  document.getElementById('reportContainer').innerHTML = '<div class="card"><p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p></div>';

  try {
    const res = await fetch('/api/staff/dashboard/stats', {
      credentials: 'include',
      });
    const data = await res.json();

    const html = `
      <div class="card">
        <h2 class="card-title">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆ</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
          <div style="padding: 1.5rem; background-color: #d1ecf1; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.875rem; color: #0c5460; margin-bottom: 0.5rem;">æœ¬æ—¥ã®äºˆç´„</div>
            <div style="font-size: 2.5rem; font-weight: 600; color: #0c5460;">${data.todayReservations || 0}</div>
          </div>
          <div style="padding: 1.5rem; background-color: #d4edda; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.875rem; color: #155724; margin-bottom: 0.5rem;">ä»Šå¾Œã®äºˆç´„</div>
            <div style="font-size: 2.5rem; font-weight: 600; color: #155724;">${data.upcomingReservations || 0}</div>
          </div>
          <div style="padding: 1.5rem; background-color: #f8d7da; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.875rem; color: #721c24; margin-bottom: 0.5rem;">æœªæ±ºæ¸ˆ</div>
            <div style="font-size: 2.5rem; font-weight: 600; color: #721c24;">${data.pendingPayments || 0}</div>
          </div>
          <div style="padding: 1.5rem; background-color: #fff3cd; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.875rem; color: #856404; margin-bottom: 0.5rem;">ä»Šæœˆã®å£²ä¸Š</div>
            <div style="font-size: 2rem; font-weight: 600; color: #856404;">Â¥${(data.monthlyRevenue || 0).toLocaleString()}</div>
          </div>
        </div>

        ${data.recentApplications && data.recentApplications.length > 0 ? `
          <h3 style="margin-bottom: 1rem;">æœ€è¿‘ã®ç”³è«‹</h3>
          <div style="overflow-x: auto;">
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>ã‚¤ãƒ™ãƒ³ãƒˆå</th>
                  <th>ç”³è«‹è€…</th>
                  <th>é‡‘é¡</th>
                  <th>æ±ºæ¸ˆçŠ¶æ³</th>
                </tr>
              </thead>
              <tbody>
                ${data.recentApplications.slice(0, 10).map(app => `
                  <tr>
                    <td>${app.id}</td>
                    <td>${app.eventName}</td>
                    <td>${app.applicantName}</td>
                    <td>Â¥${(app.totalAmount || 0).toLocaleString()}</td>
                    <td>
                      <span class="badge badge-${app.paymentStatus === 'paid' ? 'success' : app.paymentStatus === 'unpaid' ? 'warning' : 'info'}">
                        ${app.paymentStatus === 'paid' ? 'æ”¯æ‰•æ¸ˆ' : app.paymentStatus === 'unpaid' ? 'æœªæ±ºæ¸ˆ' : 'è¿”é‡‘æ¸ˆ'}
                      </span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : ''}
      </div>
    `;

    document.getElementById('reportContainer').innerHTML = html;
  } catch (error) {
    console.error('Error loading dashboard stats:', error);
    document.getElementById('reportContainer').innerHTML = '<div class="card"><p style="text-align: center; color: #e74c3c;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
  }
}

// åˆæœŸè¡¨ç¤º
document.addEventListener('DOMContentLoaded', () => {
  showDashboardStats();
});
</script>
