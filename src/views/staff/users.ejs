<div class="page-header">
  <h1 class="page-title">åˆ©ç”¨è€…ç®¡ç†</h1>
  <p class="page-description">åˆ©ç”¨è€…ã®æ¤œç´¢ã€è©³ç´°ç¢ºèªã€æƒ…å ±ç·¨é›†</p>
</div>

<!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
  <div class="card" style="text-align: center;">
    <h3 style="color: #7f8c8d; font-size: 0.875rem; margin-bottom: 0.5rem;">ç·åˆ©ç”¨è€…æ•°</h3>
    <p style="font-size: 2.5rem; font-weight: 600; color: #3498db;" id="totalUsers">-</p>
  </div>
  <div class="card" style="text-align: center;">
    <h3 style="color: #7f8c8d; font-size: 0.875rem; margin-bottom: 0.5rem;">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</h3>
    <p style="font-size: 2.5rem; font-weight: 600; color: #27ae60;" id="activeUsers">-</p>
  </div>
  <div class="card" style="text-align: center;">
    <h3 style="color: #7f8c8d; font-size: 0.875rem; margin-bottom: 0.5rem;">ä»Šæœˆã®æ–°è¦</h3>
    <p style="font-size: 2.5rem; font-weight: 600; color: #f39c12;" id="newUsersThisMonth">-</p>
  </div>
  <div class="card" style="text-align: center;">
    <h3 style="color: #7f8c8d; font-size: 0.875rem; margin-bottom: 0.5rem;">ãƒ¡ãƒ¼ãƒ«èªè¨¼æ¸ˆ</h3>
    <p style="font-size: 2.5rem; font-weight: 600; color: #9b59b6;" id="verifiedUsers">-</p>
  </div>
</div>

<!-- æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
<div class="card">
  <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem;">
    <input type="text" id="searchText" placeholder="åå‰ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ¤œç´¢..." style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
    <div style="display: flex; gap: 1rem;">
      <select id="statusFilter" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">ã™ã¹ã¦</option>
        <option value="active">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¿</option>
        <option value="inactive">éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¿</option>
      </select>
      <button onclick="loadUsers()" class="btn btn-primary">æ¤œç´¢</button>
    </div>
  </div>
</div>

<!-- åˆ©ç”¨è€…ä¸€è¦§ -->
<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h2 class="card-title" style="margin: 0;">åˆ©ç”¨è€…ä¸€è¦§</h2>
    <div style="display: flex; gap: 1rem; align-items: center;">
      <div id="totalCount" style="color: #7f8c8d;"></div>
      <button onclick="exportToCSV()" class="btn" style="background-color: #27ae60; color: white;">ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    </div>
  </div>
  <div id="usersContainer">
    <p style="text-align: center; color: #7f8c8d;">èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>
</div>

<!-- åˆ©ç”¨è€…è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="detailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
  <div style="background-color: white; max-width: 900px; margin: 2rem auto; border-radius: 8px; padding: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="margin: 0;">åˆ©ç”¨è€…è©³ç´°</h2>
      <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
    </div>
    <div id="detailContent"></div>
  </div>
</div>

<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1001; overflow-y: auto;">
  <div style="background-color: white; max-width: 600px; margin: 2rem auto; border-radius: 8px; padding: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="margin: 0;">åˆ©ç”¨è€…æƒ…å ±ç·¨é›†</h2>
      <button onclick="closeEditModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
    </div>
    <div id="editContent"></div>
  </div>
</div>

<script>
const token = document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
let currentUserId = null;
let currentUsers = [];

// åˆæœŸãƒ­ãƒ¼ãƒ‰
document.addEventListener('DOMContentLoaded', () => {
  loadStats();
  loadUsers();
});

// çµ±è¨ˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿
async function loadStats() {
  try {
    const res = await fetch('/api/staff/users/stats/summary', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const stats = await res.json();

    document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
    document.getElementById('activeUsers').textContent = stats.activeUsers || 0;
    document.getElementById('newUsersThisMonth').textContent = stats.newUsersThisMonth || 0;
    document.getElementById('verifiedUsers').textContent = stats.verifiedUsers || 0;
  } catch (error) {
    console.error('Error loading stats:', error);
  }
}

// åˆ©ç”¨è€…ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
async function loadUsers() {
  const search = document.getElementById('searchText').value;
  const status = document.getElementById('statusFilter').value;

  const params = new URLSearchParams();
  if (search) params.append('search', search);
  if (status) params.append('status', status);

  try {
    const res = await fetch(`/api/staff/users?${params}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();

    // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ã«ä¿å­˜
    currentUsers = data.users || [];

    if (data.users && data.users.length > 0) {
      document.getElementById('totalCount').textContent = `å…¨ ${data.users.length} ä»¶`;

      const html = `
        <div style="overflow-x: auto;">
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>åå‰</th>
                <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                <th>å½¹å‰²</th>
                <th>ãƒ¡ãƒ¼ãƒ«èªè¨¼</th>
                <th>çŠ¶æ…‹</th>
                <th>ç™»éŒ²æ—¥</th>
                <th>æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${data.users.map(user => `
                <tr>
                  <td>${user.id}</td>
                  <td>${user.name || '-'}</td>
                  <td>${user.email}</td>
                  <td>
                    <span class="badge badge-${user.role === 'admin' ? 'danger' : user.role === 'staff' ? 'warning' : 'info'}">
                      ${user.role === 'admin' ? 'ç®¡ç†è€…' : user.role === 'staff' ? 'è·å“¡' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'}
                    </span>
                  </td>
                  <td>
                    <span class="badge badge-${user.emailVerified ? 'success' : 'warning'}">
                      ${user.emailVerified ? 'èªè¨¼æ¸ˆ' : 'æœªèªè¨¼'}
                    </span>
                  </td>
                  <td>
                    <span class="badge badge-${user.isActive ? 'success' : 'danger'}">
                      ${user.isActive ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–'}
                    </span>
                  </td>
                  <td>${new Date(user.createdAt).toLocaleDateString('ja-JP')}</td>
                  <td>${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleDateString('ja-JP') : '-'}</td>
                  <td>
                    <button onclick="showDetail(${user.id})" class="btn btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">è©³ç´°</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      document.getElementById('usersContainer').innerHTML = html;
    } else {
      document.getElementById('totalCount').textContent = '';
      document.getElementById('usersContainer').innerHTML = '<p style="text-align: center; color: #7f8c8d;">åˆ©ç”¨è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
    }
  } catch (error) {
    console.error('Error loading users:', error);
    document.getElementById('usersContainer').innerHTML = '<p style="text-align: center; color: #e74c3c;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
  }
}

// åˆ©ç”¨è€…è©³ç´°ã‚’è¡¨ç¤º
async function showDetail(id) {
  currentUserId = id;

  try {
    const res = await fetch(`/api/staff/users/${id}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const user = await res.json();

    const html = `
      <div style="display: grid; gap: 1.5rem;">
        <!-- åŸºæœ¬æƒ…å ± -->
        <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
          <h3 style="margin-bottom: 1rem; color: #2c3e50;">åŸºæœ¬æƒ…å ±</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div>
              <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</strong> ${user.id}
            </div>
            <div>
              <strong>å½¹å‰²:</strong>
              <span class="badge badge-${user.role === 'admin' ? 'danger' : user.role === 'staff' ? 'warning' : 'info'}">
                ${user.role === 'admin' ? 'ç®¡ç†è€…' : user.role === 'staff' ? 'è·å“¡' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'}
              </span>
            </div>
            <div>
              <strong>åå‰:</strong> ${user.name || '-'}
            </div>
            <div>
              <strong>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :</strong> ${user.nickname || '-'}
            </div>
            <div style="grid-column: 1 / -1;">
              <strong>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</strong> ${user.email}
            </div>
            ${user.bio ? `
              <div style="grid-column: 1 / -1;">
                <strong>è‡ªå·±ç´¹ä»‹:</strong>
                <p style="margin-top: 0.5rem; padding: 0.5rem; background-color: white; border-radius: 4px;">${user.bio}</p>
              </div>
            ` : ''}
          </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ± -->
        <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
          <h3 style="margin-bottom: 1rem; color: #2c3e50;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div>
              <strong>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹:</strong>
              <span class="badge badge-${user.isActive ? 'success' : 'danger'}" style="margin-left: 0.5rem;">
                ${user.isActive ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–'}
              </span>
            </div>
            <div>
              <strong>ãƒ¡ãƒ¼ãƒ«èªè¨¼:</strong>
              <span class="badge badge-${user.emailVerified ? 'success' : 'warning'}" style="margin-left: 0.5rem;">
                ${user.emailVerified ? 'èªè¨¼æ¸ˆ' : 'æœªèªè¨¼'}
              </span>
            </div>
            <div>
              <strong>ç™»éŒ²æ—¥:</strong> ${new Date(user.createdAt).toLocaleString('ja-JP')}
            </div>
            <div>
              <strong>æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³:</strong> ${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleString('ja-JP') : '-'}
            </div>
            <div>
              <strong>æ›´æ–°æ—¥:</strong> ${new Date(user.updatedAt).toLocaleString('ja-JP')}
            </div>
          </div>
        </div>

        <!-- åˆ©ç”¨çµ±è¨ˆ -->
        ${user.stats ? `
          <div style="padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
            <h3 style="margin-bottom: 1rem; color: #2c3e50;">åˆ©ç”¨çµ±è¨ˆ</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
              <div style="text-align: center; padding: 1rem; background-color: white; border-radius: 4px;">
                <div style="font-size: 0.875rem; color: #7f8c8d; margin-bottom: 0.5rem;">ç·äºˆç´„æ•°</div>
                <div style="font-size: 1.75rem; font-weight: 600; color: #3498db;">${user.stats.totalReservations || 0}</div>
              </div>
              <div style="text-align: center; padding: 1rem; background-color: white; border-radius: 4px;">
                <div style="font-size: 0.875rem; color: #7f8c8d; margin-bottom: 0.5rem;">ç·æ”¯æ‰•é¡</div>
                <div style="font-size: 1.75rem; font-weight: 600; color: #27ae60;">Â¥${(user.stats.totalSpent || 0).toLocaleString()}</div>
              </div>
              <div style="text-align: center; padding: 1rem; background-color: white; border-radius: 4px;">
                <div style="font-size: 0.875rem; color: #7f8c8d; margin-bottom: 0.5rem;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ•°</div>
                <div style="font-size: 1.75rem; font-weight: 600; color: #e74c3c;">${user.stats.cancelledReservations || 0}</div>
              </div>
            </div>
          </div>
        ` : ''}

        <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
        <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #ecf0f1;">
          <button onclick="showEditModal(${user.id})" class="btn btn-primary">æƒ…å ±ã‚’ç·¨é›†</button>
          ${user.role === 'user' ? `
            <button onclick="toggleActive(${user.id}, ${user.isActive})" class="btn ${user.isActive ? 'btn-danger' : 'btn-success'}">
              ${user.isActive ? 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹' : 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹'}
            </button>
          ` : ''}
        </div>
      </div>
    `;

    document.getElementById('detailContent').innerHTML = html;
    document.getElementById('detailModal').style.display = 'block';
  } catch (error) {
    console.error('Error loading user detail:', error);
    alert('è©³ç´°æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeDetailModal() {
  document.getElementById('detailModal').style.display = 'none';
  currentUserId = null;
}

// ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
async function showEditModal(id) {
  try {
    const res = await fetch(`/api/staff/users/${id}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const user = await res.json();

    const html = `
      <form id="editForm" style="display: grid; gap: 1rem;">
        <div>
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">åå‰ *</label>
          <input type="text" id="editName" value="${user.name || ''}" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div>
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
          <input type="text" id="editNickname" value="${user.nickname || ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div>
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
          <input type="email" id="editEmail" value="${user.email}" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div>
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">è‡ªå·±ç´¹ä»‹</label>
          <textarea id="editBio" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${user.bio || ''}</textarea>
        </div>

        <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #ecf0f1;">
          <button type="button" onclick="closeEditModal()" class="btn" style="background-color: #95a5a6; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    `;

    document.getElementById('editContent').innerHTML = html;
    document.getElementById('editModal').style.display = 'block';

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('editForm').addEventListener('submit', (e) => {
      e.preventDefault();
      updateUser(id);
    });
  } catch (error) {
    console.error('Error loading user for edit:', error);
    alert('ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
}

// åˆ©ç”¨è€…æƒ…å ±ã‚’æ›´æ–°
async function updateUser(id) {
  const name = document.getElementById('editName').value.trim();
  const nickname = document.getElementById('editNickname').value.trim();
  const email = document.getElementById('editEmail').value.trim();
  const bio = document.getElementById('editBio').value.trim();

  if (!name || !email) {
    alert('åå‰ã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™');
    return;
  }

  try {
    const res = await fetch(`/api/staff/users/${id}`, {
      method: 'PATCH',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ name, nickname, email, bio })
    });

    if (res.ok) {
      alert('åˆ©ç”¨è€…æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      closeEditModal();
      closeDetailModal();
      loadUsers();
      loadStats();
    } else {
      const error = await res.json();
      alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }
  } catch (error) {
    console.error('Error updating user:', error);
    alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
async function toggleActive(id, currentStatus) {
  const action = currentStatus ? 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–';
  if (!confirm(`ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’${action}ã«ã—ã¾ã™ã‹ï¼Ÿ`)) {
    return;
  }

  try {
    const res = await fetch(`/api/staff/users/${id}/toggle-active`, {
      method: 'PATCH',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (res.ok) {
      alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’${action}ã«ã—ã¾ã—ãŸ`);
      closeDetailModal();
      loadUsers();
      loadStats();
    } else {
      const error = await res.json();
      alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
    }
  } catch (error) {
    console.error('Error toggling active status:', error);
    alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('detailModal').addEventListener('click', (e) => {
  if (e.target.id === 'detailModal') {
    closeDetailModal();
  }
});

document.getElementById('editModal').addEventListener('click', (e) => {
  if (e.target.id === 'editModal') {
    closeEditModal();
  }
});

// CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
function exportToCSV() {
  if (!currentUsers || currentUsers.length === 0) {
    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  // CSVãƒ˜ãƒƒãƒ€ãƒ¼
  const headers = ['ID', 'åå‰', 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', 'å½¹å‰²', 'ãƒ¡ãƒ¼ãƒ«èªè¨¼', 'çŠ¶æ…‹', 'ç™»éŒ²æ—¥', 'æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³'];

  // CSVãƒ‡ãƒ¼ã‚¿è¡Œ
  const rows = currentUsers.map(user => {
    const role = user.role === 'admin' ? 'ç®¡ç†è€…' : user.role === 'staff' ? 'è·å“¡' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
    const emailVerified = user.emailVerified ? 'èªè¨¼æ¸ˆ' : 'æœªèªè¨¼';
    const isActive = user.isActive ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–';
    const lastLoginAt = user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleDateString('ja-JP') : '-';

    return [
      user.id,
      user.name || '-',
      user.email,
      role,
      emailVerified,
      isActive,
      new Date(user.createdAt).toLocaleDateString('ja-JP'),
      lastLoginAt
    ];
  });

  // CSVå½¢å¼ã«å¤‰æ›
  const csvContent = [
    headers.join(','),
    ...rows.map(row => row.map(cell => {
      // ã‚»ãƒ«å†…ã«ã‚«ãƒ³ãƒã‚„æ”¹è¡ŒãŒã‚ã‚‹å ´åˆã¯ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€
      const cellStr = String(cell);
      if (cellStr.includes(',') || cellStr.includes('\n') || cellStr.includes('"')) {
        return '"' + cellStr.replace(/"/g, '""') + '"';
      }
      return cellStr;
    }).join(','))
  ].join('\n');

  // BOMä»˜ãUTF-8ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆExcelã§æ–‡å­—åŒ–ã‘ã—ãªã„ã‚ˆã†ã«ï¼‰
  const bom = '\uFEFF';
  const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });

  // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ã‚¯ãƒªãƒƒã‚¯
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  const now = new Date();
  const filename = `users_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}.csv`;

  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>
